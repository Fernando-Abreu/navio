// https://github.com/john-guerra/Navio#readme v0.0.21 Copyright 2019 John Alexis Guerra Gómez
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3"),require("d3-scale-chromatic")):"function"==typeof define&&define.amd?define(["d3","d3-scale-chromatic"],e):t.navio=e(t.d3,t.d3ScaleChromatic)}(this,function(t,e){"use strict";class n{constructor(t){this.first=t.first,this.last=t.last,this.level=t.level}filter(t){return t.__i[this.level]>=this.first.__i[this.level]&&t.__i[this.level]<=this.last.__i[this.level]}}class r{constructor(t){this.itemAttr=t.itemAttr,this.sel=t.sel}filter(t){return t[this.itemAttr]===this.sel[this.itemAttr]}}return function(a,i){var o,l,s,c,d,u=this||{},f=[],h=[],v=[],p=[],g=t.map(),m=t.map(),b=[],y=[],x=[],w=[],_=[],S=void 0!==i?i:600,A=t.map(),k="interpolateBlues"in t?t.interpolateBlues:e.interpolateBlues,T="interpolatePurples"in t?t.interpolatePurples:e.interpolatePurples,C="interpolateBrBG"in t?t.interpolateBrBG:e.interpolateBrBG,E=["white","#b5cf6b"],q=t.format(",.0d"),P=0,I=100,M="__seqId",z=function(){};function D(){t.event.preventDefault()}u.howManyItemsShouldSearchForNotNull=100,u.margin=10,u.attribWidth=15,u.levelsSeparation=40,u.divisionsColor="white",u.levelConvectionsColor="rgba(205, 220, 163, 0.5)",u.divisionsThreshold=4,u.attribFontSize=13,u.attribFontSizeSelected=32,u.startColor="white",u.endColor="red",u.legendFont="14px Arial",u.linkColor="#2171b5",(a=void 0===(a="string"==typeof a?t.select(a):a).selectAll?t.select(a):a).selectAll("*").remove(),a.on("touchstart",D).on("touchmove",D).style("height",S+"px").attr("class","navio").append("div").attr("id","navio").style("position","relative"),a.select("#navio").append("canvas");var O=a.select("#navio").append("svg").style("overflow","visible").style("position","absolute").style("z-index",99).style("top",0).style("left",0);O.append("g").attr("class","attribs"),O.append("g").attr("class","nvTooltip").style("text-shadow","0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff").attr("transform","translate(-100,-10)").append("text").attr("x",0).attr("y",0).style("pointer-events","none").style("font-family","sans-serif").style("font-size","16pt").style("text-anchor","middle"),O.select(".nvTooltip > text").append("tspan").attr("class","tool_id").attr("x",0).attr("dy","1.2em"),O.select(".nvTooltip > text").append("tspan").attr("class","tool_value_name").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),O.select(".nvTooltip > text").append("tspan").attr("class","tool_value_val").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),O.append("g").attr("id","closeButton").style("fill","white").style("stroke","black").style("display","none").append("path").call(function(e){var n=t.path();n.moveTo(0,0),n.lineTo(7,7),n.moveTo(7,0),n.lineTo(0,7),n.moveTo(11.9,3.5),n.arc(3.5,3.5,8.4,0,2*Math.PI),e.attr("d",n.toString())}).on("click",function(){h.length<=1||(N(this),L(h.length-2),h[h.length-2].forEach(function(t){f[t].visible=!0}),h=h.slice(0,h.length-1),u.updateData(h,A),z(u.getVisible()),F(this))}),o=t.scaleBand().range([0,u.attribWidth]).round(!0).paddingInner(.1).paddingOuter(0),s=t.scaleBand().round(!0),A=t.map(),l=function(t,e){return s(e)+o(t)},(c=a.select("canvas").node()).style.top=c.offsetTop+"px",c.style.left=c.offsetLeft+"px",c.style.height=S+"px";const B=window.devicePixelRatio;function N(e){t.select(e).style("cursor","progress"),O.style("cursor","progress")}function F(e){t.select(e).style("cursor",null),O.style("cursor",null)}function W(e,n){var r=e.domain(),a=e.range();return t.scaleQuantize().domain(a).range(r)(n)}function K(e){t.event&&t.event.defaultPrevented||(y[e.level]={attrib:e.attrib,reverse:void 0!==y[e.level]&&y[e.level].attrib===e.attrib&&!y[e.level].reverse},Z(e.level),L(e.level),u.updateData(h,A,e.level))}function L(e){t.select("#level"+e).selectAll(".brush").call(x[e].move,null)}function V(t){for(var e=0;e<h.length;e+=1)e!==t&&L(e)}function G(e,a){x[a]=t.brushY().extent([[l(o.domain()[0],a),_[a].range()[0]],[l(o.domain()[o.domain().length-1],a)+1.1*o.bandwidth(),_[a].range()[1]]]).on("end",function(){if(N(this),!t.event.sourceEvent)return;if(!t.event.selection)return;V(a),performance.now();var e=t.event.selection,r=g.get(W(_[a],e[0])),i=g.get(W(_[a],e[1]));const o=new n({first:r,last:i,level:a});t.event.sourceEvent.shiftKey?w[a].push(o):w[a]=[o];var l=d();c(l),performance.now();var s=h;0!==l.length&&((s=h.slice(0,a+1)).push(l),u.updateData(s,A),z(u.getVisible()),F(this))});var i=t.select(this).selectAll(".brush").data([{data:f[e],level:a}]);function c(t){for(var e=0;e<t.length;e++)f[t[e]].__i[a+1]=e}function d(){let t,e;t=performance.now();var n=h[a].filter(t=>{f[t].visible=!1;for(let e of w[a])if(e.filter(f[t])){f[t].visible=!0;break}return f[t].visible});return e=performance.now(),n}i.enter().merge(i).append("g").on("mousemove",R).on("click",function(){N(this);var e=t.mouse(t.event.target)[1];(function(e,n){V(-1),performance.now();var i=W(_[a],n),l=(performance.now(),W(o,e-s(a)));if(void 0===l)return;var f=g.get(i);const v=new r({sel:f,itemAttr:l});t.event.shiftKey?w[a].push(v):w[a]=[v];var p=d();c(p);var m=h.slice(0,a+1);m.push(p),u.updateData(m,A),z(u.getVisible())})(t.mouse(t.event.target)[0],e),F(this)}).on("mouseout",j).attr("class","brush").call(x[a]).selectAll("rect").attr("width",l(o.domain()[o.domain().length-1],a)+1.1*o.bandwidth()),i.exit().remove()}function R(e){var n=t.mouse(t.event.target)[1],r=t.mouse(t.event.target)[0],a=W(_[e.level],n),i=W(o,r-s(e.level)),l=g.get(a);O.select(".nvTooltip").attr("transform","translate("+r+","+(n+20)+")").call(function(t){t.select(".tool_id").text(a),t.select(".tool_value_name").text(i+" : "),t.select(".tool_value_val").text(l[i])})}function j(){O.select(".nvTooltip").attr("transform","translate(-200,-200)").call(function(t){t.select(".tool_id").text(""),t.select(".tool_value_name").text(""),t.select(".tool_value_val").text("")})}function Q(e){var n=o.domain(),r=O.select(".attribs").selectAll(".levelOverlay").data(h),a=r.enter().append("g");a.attr("class","levelOverlay").attr("id",function(t,e){return"level"+e}),e?a.merge(r).each(G):a.each(G);var i,c=a.merge(r).selectAll(".attribOverlay").data(function(t,e){return n.map(function(t){return{attrib:t,level:e}})}),d=c.enter().append("g").attr("class","attribOverlay").style("cursor","pointer");d.merge(c).attr("transform",function(t){return"translate("+l(t.attrib,t.level)+","+_[t.level].range()[0]+")"}),d.append("rect").merge(c.select("rect")).attr("fill","none").attr("x",0).attr("y",0).attr("width",function(){return 1.1*o.bandwidth()}).attr("height",function(t){return _[t.level].range()[1]-_[t.level].range()[0]}),d.append("text").merge(c.select("text")).style("cursor","point").style("-webkit-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").text(function(t){return"__seqId"===t.attrib?"sequential Index":t.attrib+(void 0!==y[t.level]&&y[t.level].attrib===t.attrib?y[t.level].reverse?" ↓":" ↑":"")}).attr("x",o.bandwidth()/2).attr("y",0).style("font-weight",function(t){return void 0!==y[t.level]&&y[t.level].attrib===t.attrib?"bolder":"normal"}).style("font-family","sans-serif").style("font-size",u.attribFontSize+"px").on("click",(i=K,function(t,e,n){N(this),setTimeout(()=>{i(t,e,n),F(this)},100)})).call(t.drag().container(d.merge(c).node()).on("start",Y).on("drag",H).on("end",J)).on("mousemove",function(){var e=t.select(this);(e=void 0!==e.transition?e.transition().duration(150):e).style("font-size",u.attribFontSizeSelected+"px")}).on("mouseout",function(){var e=t.select(this);(e=void 0!==e.transition?e.transition().duration(150):e).style("font-size",u.attribFontSize+"px")}).attr("transform","rotate(-45)"),a.append("text").merge(r.select("text.numNodesLabel")).attr("class","numNodesLabel").style("font-family","sans-serif").style("pointer-events","none").merge(r.select(".numNodesLabel")).attr("y",function(t,e){return _[e].range()[1]+15}).attr("x",function(t,e){return s(e)}).text(function(t){return q(t.length)}),c.exit().remove(),r.exit().remove()}function Y(e){t.event.sourceEvent.shiftKey&&t.select(this.parentNode).attr("transform",function(e){return"translate("+(t.event.x+u.attribFontSize/2)+","+_[e.level].range()[0]+")"})}function H(e){t.event.sourceEvent.shiftKey&&t.select(this.parentNode).attr("transform",function(e){return"translate("+(t.event.x+u.attribFontSize/2)+","+_[e.level].range()[0]+")"})}function J(e){if(t.event.sourceEvent.shiftKey){var n,r=W(o,t.event.x+u.attribFontSize/2-s(e.level));t.select(this.parentNode).attr("transform",function(t){return"translate("+l(t.attrib,t.level)+","+_[t.level].range()[0]+")"}),r!==e.attrib&&(n=b.indexOf(r),$(e.attrib,n),u.updateData(h))}}function U(t){var e=o.domain()[o.domain().length-1],n=l(e,h.length-1)+o.bandwidth(),r=_[h.length-1](t.source[M])+_[h.length-1].bandwidth()/2,a=_[h.length-1](t.target[M])+_[h.length-1].bandwidth()/2,i=Math.min(r,a),s=Math.max(r,a),c=s-i;d.moveTo(n,i),d.quadraticCurveTo(n+c/6,i+c/2,n,s)}function X(t,e,n,r){d.beginPath(),t.forEach(function(t,e){0===e?d.moveTo(t.x,t.y):d.lineTo(t.x,t.y)}),d.lineWidth=e,r?(d.fillStyle=n,d.closePath(),d.fill()):(d.strokeStyle=n,d.stroke())}function Z(t){if(!y.hasOwnProperty(t))return;performance.now();const e=y[t];h[t]=h[t].sort(function(t,n){return e.reverse?function(t,e){return null===t?null===e?0:-1:e<t?-1:e>t?1:e>=t?0:NaN}(f[t][e.attrib],f[n][e.attrib]):function(t,e){return null===e?null===t?0:-1:t<e?-1:t>e?1:t>=e?0:NaN}(f[t][e.attrib],f[n][e.attrib])}),h[t].forEach(function(e,n){f[e].__i[t]=n}),performance.now()}function $(t,e){var n=b.indexOf(t);-1!==n?e>b.length||e<0?console.err("moveAttrToPos pos out of bounds",e,b.length):(b.splice(n,1),b.splice(e,0,t)):console.err("moveAttrToPos attr not found",t)}return c.height=S*B,(d=c.getContext("2d")).scale(B,B),d.imageSmoothingEnabled=d.mozImageSmoothingEnabled=d.webkitImageSmoothingEnabled=!1,d.globalCompositeOperation="source-over",u.initData=function(e,n){performance.now(),(A=n).keys().forEach(function(t){m.set(t,!0)}),g=t.map();for(var r=0;r<f.length;r++){var a=f[r];a.__seqId=r,g.set(a[M],a),a.__i={},a.__i[0]=r}(w=[])[0]=[],performance.now()},u.updateData=function(e,n,r){var a;performance.now(),typeof e==typeof[]?(A=void 0!==n?n:A,h=e,w.splice(e.length),w[e.length]=[],v.length>0&&(p=v.filter(function(t){return t.source.visible&&t.target.visible})),x.splice(e.length),Z(e.length-1),function(e){performance.now();var n=h.length-1;_.splice(n+1,_.length),_[e=void 0!==e?e:n]=t.scaleBand().range([I,S-u.margin-30]).paddingInner(0).paddingOuter(0);var r=[];if(h[e].length>S){var a=Math.max(Math.floor(h[e].length/(2*S)),1);h[e].itemsPerpixel=a;for(var i=0;i<h[e].length;i+=a)r.push(h[e][i])}else h[e].itemsPerpixel=1,r=h[e];h[e].representatives=r,_[e].domain(r.map(function(t){return f[t][M]})),m.keys().forEach(function(e){if("visible"!==e){var n=A.get(e);if("seq"===n.__type||"date"===n.__type)n.domain(t.extent(h[0].map(function(t){return f[t][e]})));else if("div"===n.__type){const[r,a]=t.extent(h[0].map(function(t){return f[t][e]})),i=Math.max(-r,a);n.domain([-i,i])}A.set(e,n)}}),o.domain(b).range([0,u.attribWidth*m.keys().length]).paddingInner(.1).paddingOuter(0),s.domain(h.map(function(t,e){return e})).range([P+u.margin,(o.range()[1]+u.levelsSeparation)*h.length+P]).paddingInner(0).paddingOuter(0),performance.now()}(r),a=s.range()[1]+u.margin+P,t.select(c).attr("width",a).attr("height",S).style("width",a).style("height",S+"px"),c.style.width=a+"px",c.style.height=S+"px",O.attr("width",a).attr("height",S),u.update(),performance.now()):console.error("navio updateData didn't receive an array")},u.update=function(t){var e,n=void 0!==t&&t,r=(performance.now(),s.range()[1]+u.margin+P);d.clearRect(0,0,r+1,S+1),h.forEach(function(t,e){var n;!function(t){d.beginPath(),d.rect(s(t),_[t].range()[0]-1,o.range()[1]+1,_[t].range()[1]+2-100),d.strokeStyle="black",d.lineWidth=1,d.stroke()}(e),t.representatives.forEach(function(t){!function(t,e){var n,r,a;for(_[e].bandwidth(),u.divisionsThreshold,r=0;r<b.length;r++)if(n=b[r],a=Math.round(_[e](t[M])+_[e].bandwidth()/2),d.beginPath(),d.moveTo(Math.round(l(n,e)),a),d.lineTo(Math.round(l(n,e)+o.bandwidth()),a),d.lineWidth=Math.ceil(_[e].bandwidth())+1,d.strokeStyle=void 0===t[n]||null===t[n]||""===t[n]||"none"===t[n]?"white":A.get(n)(t[n]),d.stroke(),_[e].bandwidth()>2*u.divisionsThreshold){var i=Math.round(_[e](t[M]));d.beginPath(),d.moveTo(l(n,e),i),d.lineTo(l(n,e)+o.bandwidth(),i),d.lineWidth=1,d.strokeStyle=u.divisionsColor,d.stroke()}}(f[t],e)}),(n=e)<=0||h[n].representatives.forEach(function(t){var e=g.get(f[t][M]).__i[n-1],r=Math.floor(e-e%h[n-1].itemsPerpixel),a={x:s(n-1)+o.range()[1],y:_[n-1](f[h[n-1][r]][M])},i={x:s(n),y:_[n](f[t][M])},l=[a,{x:a.x+.3*u.levelsSeparation,y:a.y},{x:i.x-.3*u.levelsSeparation,y:i.y},i,{x:i.x,y:i.y+_[n].bandwidth()},{x:i.x-.3*u.levelsSeparation,y:i.y+_[n].bandwidth()},{x:a.x+.3*u.levelsSeparation,y:a.y+_[n-1].bandwidth()},{x:a.x,y:a.y+_[n-1].bandwidth()},a];X(l,1,u.levelConvectionsColor),X(l,1,u.levelConvectionsColor,!0)})}),v.length&&(d.save(),d.beginPath(),d.strokeStyle=u.linkColor,d.globalAlpha=Math.min(1,Math.max(.1,1e3/v[v.length-1].length)),p.forEach(U),d.stroke(),d.restore()),Q(n),e=h.length-1,O.select("#closeButton").style("display",1===h.length?"none":"block").attr("transform","translate("+(s(e)+s.bandwidth()-u.levelsSeparation+15)+","+_[e].range()[0]+")"),performance.now()},u.addAttrib=function(t,e){if(-1===b.indexOf(t))return b.push(t),A.set(t,e),u},u.addSequentialAttrib=function(e,n){const r=void 0!==f&&f.length>0?t.extent(f,function(t){return t[e]}):[0,1],a=n||t.scaleSequential(k).domain(r);return a.__type="seq",u.addAttrib(e,a),u},u.addDateAttrib=function(e,n){const r=void 0!==f&&f.length>0?t.extent(f,function(t){return t[e]}):[0,1],a=n||t.scaleSequential(T).domain(r);return u.addAttrib(e,a),a.__type="date",u},u.addDivergingAttrib=function(e,n){const r=void 0!==f&&f.length>0?t.extent(f,function(t){return t[e]}):[-1,1],a=n||t.scaleSequential(C).domain([r[0],r[1]]);return a.__type="div",u.addAttrib(e,a),u},u.addCategoricalAttrib=function(e,n){const r=n||t.scaleOrdinal(t.schemeCategory10);return r.__type="cat",u.addAttrib(e,r),u},u.addAllAttribs=function(e){if(!f||!f.length)throw Error("addAllAttribs called without data to guess the attribs. Make sure to call it after setting the data");return(void 0!==e?e:function(t){var e,n=[];for(e in t)t.hasOwnProperty(e)&&n.push(e);return n}(f[0])).forEach(function(e){if("__seqId"===e||"__i"===e)return;const n=function(t,e){let n;for(n=0;n<u.howManyItemsShouldSearchForNotNull&&n<t.length;n++)if(null!==t[0][e]&&void 0!==t[0][e]&&""!==t[0][e])return t[n][e];return t[n][e]}(f,e);null==n||""===n?u.addCategoricalAttrib(e):"number"==typeof n?t.min(f,t=>t[e])<0?u.addDivergingAttrib(e):u.addSequentialAttrib(e):typeof n==typeof new Date?u.addDateAttrib(e):u.addCategoricalAttrib(e)}),u.data(f),Q(!0),u},u.data=function(e){return A.has("visible")||(u.addAttrib("visible",t.scaleOrdinal().domain([!1,!0]).range(E)),$("visible",0)),A.has("__seqId")||(u.addSequentialAttrib("__seqId"),$("__seqId",1)),arguments.length?(e.forEach(function(t){t.visible=!0}),h=[(f=e).map(function(t,e){return e})],u.initData(h,A),u.updateData(h,A),u):f[0]},u.getVisible=function(){return h[h.length-1].filter(function(t){return f[t].visible}).map(function(t){return f[t]})},u.updateCallback=function(t){return arguments.length?(z=t,u):z},u.visibleColorRange=function(t){return arguments.length?(E=t,u):E},u.defaultColorInterpolator=function(t){return arguments.length?(k=t,u):k},u.id=function(t){return arguments.length?(M=t,u):M},u.links=function(t){return arguments.length?(v=t,u):v},u}});
