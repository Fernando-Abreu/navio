// https://github.com/john-guerra/Navio#readme v0.0.13 Copyright 2018 John Alexis Guerra GÃ³mez
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("d3-scale-chromatic")):"function"==typeof define&&define.amd?define(["d3","d3-scale-chromatic"],t):e.navio=t(e.d3,e.d3ScaleChromatic)}(this,function(e,t){"use strict";return function(n,o){var a,l,r,i,s,c=this||{},d=[],u=[],f=e.map(),v=e.map(),p=[],g=e.map(),h=e.map(),m=[],b=void 0!==o?o:600,y=e.map(),x="interpolateBlues"in e?e.interpolateBlues:t.interpolateBlues,w=["white","#b5cf6b"],_=e.format(",.0d"),S=0,k=100,C="__seqId",A=function(){};function z(){console.log("nozoom"),e.event.preventDefault()}c.margin=10,c.attribWidth=15,c.levelsSeparation=40,c.divisionsColor="white",c.levelConvectionsColor="rgba(205, 220, 163, 0.5)",c.divisionsThreshold=3,c.attribFontSize=13,c.attribFontSizeSelected=32,c.startColor="white",c.endColor="red",c.legendFont="14px Arial",c.linkColor="#2171b5",(n=void 0===(n="string"==typeof n?e.select(n):n).selectAll?e.select(n):n).selectAll("*").remove(),n.on("touchstart",z).on("touchmove",z).style("height",b+"px").attr("class","navio").append("div").attr("id","navio").style("position","relative"),n.select("#navio").append("canvas");var T=n.select("#navio").append("svg").style("overflow","visible").style("position","absolute").style("z-index",99).style("top",0).style("left",0);T.append("g").attr("class","attribs"),T.append("g").attr("class","tooltip").style("text-shadow","0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff").attr("transform","translate(-100,-10)").append("text").attr("x",0).attr("y",0).style("pointer-events","none").style("font-family","sans-serif").style("font-size","16pt").style("text-anchor","middle"),T.select(".tooltip > text").append("tspan").attr("class","tool_id").attr("x",0).attr("dy","1.2em"),T.select(".tooltip > text").append("tspan").attr("class","tool_value_name").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),T.select(".tooltip > text").append("tspan").attr("class","tool_value_val").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),T.append("g").attr("id","closeButton").style("fill","white").style("stroke","black").style("display","none").append("path").call(function(t){var n=e.path();n.moveTo(0,0),n.lineTo(7,7),n.moveTo(7,0),n.lineTo(0,7),n.moveTo(11.9,3.5),n.arc(3.5,3.5,8.4,0,2*Math.PI),t.attr("d",n.toString())}).on("click",function(){u.length<=1||(console.log("Delete one level"),O(u.length-2),u[u.length-2].forEach(function(e){d[e].visible=!0}),u=u.slice(0,u.length-1),c.updateData(u,y),A(c.getVisible()))}),a=e.scaleBand().range([0,c.attribWidth]).round(!0).paddingInner(.1).paddingOuter(0),r=e.scaleBand().round(!0),y=e.map(),l=function(e,t){return r(t)+a(e)},(i=n.select("canvas").node()).style.top=i.offsetTop+"px",i.style.left=i.offsetLeft+"px",i.style.height=b+"px";const D=window.devicePixelRatio;function E(t,n){var o=t.domain(),a=t.range();return e.scaleQuantize().domain(a).range(o)(n)}function I(t){if(!e.event||!e.event.defaultPrevented){console.log("click "+t);var n=performance.now();u[t.level]=u[t.level].sort(function(n,o){return e.ascending(d[n][t.attrib],d[o][t.attrib])}),u[t.level].forEach(function(e,n){d[e].__i[t.level]=n});var o=performance.now();console.log("Click sorting "+(o-n)+"ms"),g.set(t.level,t.attrib),c.updateData(u,y,t.level)}}function O(t){e.select("#level"+t).selectAll(".brush").call(h.get(t).move,null)}function P(e){for(var t=0;t<u.length;t+=1)t!==e&&O(t)}function q(t,n){h.set(n,e.brushY().extent([[l(a.domain()[0],n),m[n].range()[0]],[l(a.domain()[a.domain().length-1],n)+1.1*a.bandwidth(),m[n].range()[1]]]).on("end",function(){if(e.event.sourceEvent)if(e.event.selection){P(n);for(var t=performance.now(),o=e.event.selection,a=f.get(E(m[n],o[0])),l=f.get(E(m[n],o[1])),r=u[n].filter(function(e){return d[e].visible=d[e].__i[n]>=a.__i[n]&&d[e].__i[n]<=l.__i[n],d[e].visible}),i=0;i<r.length;i++)d[r[i]].__i[n+1]=i;var s=performance.now();console.log("Brushend filtering "+(s-t)+"ms"),console.log("Computing new data");var v=u;0!==r.length?((v=u.slice(0,n+1)).push(r),c.updateData(v,y),console.log("out of updateData"),console.log("Selected "+r.length+" calling updateCallback"),A(c.getVisible())):console.log("Empty selection!")}else console.log("Empty selection",e.event.selection,e.event.type,e.event.sourceEvent)}));var o=e.select(this).selectAll(".brush").data([{data:d[t],level:n}]);o.enter().merge(o).append("g").on("mousemove",B).on("click",function(){console.log("click");var t=e.mouse(e.event.target)[1];!function(e,t){console.log("onSelectByValueFromCoords",e,t),P(-1);var o=performance.now(),l=E(m[n],t),i=performance.now();console.log("invertOrdinalScale "+(i-o)+"ms");var s=E(a,e-r(n));if(void 0!==s){var v=f.get(l);o=performance.now();var p=u[n].filter(function(e){return d[e].visible=d[e][s]===v[s],d[e].visible});p.forEach(function(e,t){d[e].__i[n+1]=t}),i=performance.now(),console.log("Click filtering "+(i-o)+"ms");var g=u.slice(0,n+1);g.push(p),c.updateData(g,y),console.log("Selected "+c.getVisible().length+" calling updateCallback"),A(c.getVisible())}}(e.mouse(e.event.target)[0],t)}).on("mouseout",F).attr("class","brush").call(h.get(n)).selectAll("rect").attr("width",l(a.domain()[a.domain().length-1],n)+1.1*a.bandwidth()),o.exit().remove()}function B(t){var n=e.mouse(e.event.target)[1],o=e.mouse(e.event.target)[0],l=E(m[t.level],n),i=E(a,o-r(t.level)),s=f.get(l);T.select(".tooltip").attr("transform","translate("+o+","+(n+20)+")").call(function(e){e.select(".tool_id").text(l),e.select(".tool_value_name").text(i+" : "),e.select(".tool_value_val").text(s[i])})}function F(){T.select(".tooltip").attr("transform","translate(-200,-200)").call(function(e){e.select(".tool_id").text(""),e.select(".tool_value_name").text(""),e.select(".tool_value_val").text("")})}function M(t){console.log("start",t),e.select(this.parentNode).attr("transform",function(t){return"translate("+(e.event.x+c.attribFontSize/2)+","+m[t.level].range()[0]+")"})}function W(t){e.select(this.parentNode).attr("transform",function(t){return"translate("+(e.event.x+c.attribFontSize/2)+","+m[t.level].range()[0]+")"})}function V(t){console.log("end",t);var n,o=E(a,e.event.x+c.attribFontSize/2-r(t.level));e.select(this.parentNode).attr("transform",function(e){return"translate("+l(e.attrib,e.level)+","+m[e.level].range()[0]+")"}),o!==t.attrib&&(n=p.indexOf(o),R(t.attrib,n),c.updateData(u))}function N(e,t,n,o){s.beginPath(),e.forEach(function(e,t){0===t?s.moveTo(e.x,e.y):s.lineTo(e.x,e.y)}),s.lineWidth=t,o?(s.fillStyle=n,s.closePath(),s.fill()):(s.strokeStyle=n,s.stroke())}function R(e,t){var n=p.indexOf(e);-1!==n?t>p.length||t<0?console.err("moveAttrToPos pos out of bounds",t,p.length):(p.splice(n,1),p.splice(t,0,e)):console.err("moveAttrToPos attr not found",e)}return i.height=b*D,(s=i.getContext("2d")).scale(D,D),c.initData=function(t,n){var o=performance.now();(y=n).keys().forEach(function(e){v.set(e,!0)}),f=e.map();for(var a=0;a<d.length;a++){var l=d[a];l.__seqId=a,f.set(l[C],l),l.__i={},l.__i[0]=a}var r=performance.now();console.log("Init data "+(r-o)+"ms")},c.updateData=function(t,n,o){console.log("updateData");var l,s=performance.now();if(typeof t==typeof[]){y=void 0!==n?n:y,u=t,function(t){console.log("Update scales");var n=performance.now(),o=u.length-1;console.log("Delete unvecessary scales"),m.splice(o+1,m.length),m[t=void 0!==t?t:o]=e.scaleBand().range([k,b-c.margin-30]).paddingInner(0).paddingOuter(0),console.log("Compute representatives");var l=[];if(u[t].length>b){var i=Math.max(Math.floor(u[t].length/(2*b)),1);console.log("itemsPerpixel",i),u[t].itemsPerpixel=i;for(var s=0;s<u[t].length;s+=i)l.push(u[t][s])}else u[t].itemsPerpixel=1,l=u[t];u[t].representatives=l,m[t].domain(l.map(function(e){return d[e][C]})),console.log("Update color scale domains"),v.keys().forEach(function(t){if("visible"!==t){var n=y.get(t);n.domain(e.extent(u[0].representatives.map(function(e){return d[e][t]}))),y.set(t,n)}}),a.domain(p).range([0,c.attribWidth*v.keys().length]).paddingInner(.1).paddingOuter(0),r.domain(u.map(function(e,t){return t})).range([S+c.margin,(a.range()[1]+c.levelsSeparation)*u.length+S]).paddingInner(0).paddingOuter(0);var f=performance.now();console.log("Updating Scales "+(f-n)+"ms")}(o),l=r.range()[1]+c.margin+S,e.select(i).attr("width",l).attr("height",b).style("width",l).style("height",b+"px"),i.style.width=l+"px",i.style.height=b+"px",T.attr("width",l).attr("height",b),c.update();var f=performance.now();console.log("Updating data "+(f-s)+"ms")}else console.error("navio updateData didn't receive an array")},c.update=function(){var t,n,o,i,v,h,x=performance.now(),w=r.range()[1]+c.margin+S;s.clearRect(0,0,w+1,b+1),u.forEach(function(e,t){var n;e.representatives.forEach(function(e){!function(e,t){var n,o,r;for(o=0;o<p.length;o++)if(n=p[o],r=Math.round(m[t](e[C])+m[t].bandwidth()/2),s.beginPath(),s.moveTo(Math.round(l(n,t)),r),s.lineTo(Math.round(l(n,t)+a.bandwidth()),r),s.lineWidth=Math.round(m[t].bandwidth()),s.strokeStyle=void 0===e[n]||null===e[n]||"none"===e[n]?"white":y.get(n)(e[n]),s.stroke(),m[t].bandwidth()>c.divisionsThreshold){var i=Math.round(m[t](e[C]));s.beginPath(),s.moveTo(l(n,t),i),s.lineTo(l(n,t)+a.bandwidth(),i),s.lineWidth=1,s.strokeStyle=c.divisionsColor,s.stroke()}}(d[e],t)}),function(e){s.beginPath(),s.rect(r(e),m[e].range()[0],a.range()[1],m[e].range()[1]-100),s.strokeStyle="black",s.lineWidth=1,s.stroke()}(t),(n=t)<=0||u[n].representatives.forEach(function(e){var t=f.get(d[e][C]).__i[n-1],o=Math.floor(t-t%u[n-1].itemsPerpixel),l={x:r(n-1)+a.range()[1],y:m[n-1](d[u[n-1][o]][C])},i={x:r(n),y:m[n](d[e][C])},s=[l,{x:l.x+.3*c.levelsSeparation,y:l.y},{x:i.x-.3*c.levelsSeparation,y:i.y},i,{x:i.x,y:i.y+m[n].bandwidth()},{x:i.x-.3*c.levelsSeparation,y:i.y+m[n].bandwidth()},{x:l.x+.3*c.levelsSeparation,y:l.y+m[n-1].bandwidth()},{x:l.x,y:l.y+m[n-1].bandwidth()},l];N(s,1,c.levelConvectionsColor),N(s,1,c.levelConvectionsColor,!0)})}),t=a.domain(),n=T.select(".attribs").selectAll(".levelOverlay").data(u),o=n.enter().append("g").attr("class","levelOverlay").attr("id",function(e,t){return"level"+t}).each(q),i=o.merge(n).selectAll(".attribOverlay").data(function(e,n){return t.map(function(e){return{attrib:e,level:n}})}),(v=i.enter().append("g").attr("class","attribOverlay").style("cursor","pointer")).merge(i).attr("transform",function(e){return"translate("+l(e.attrib,e.level)+","+m[e.level].range()[0]+")"}),v.append("rect").merge(i.select("rect")).attr("fill","none").attr("x",0).attr("y",0).attr("width",function(){return 1.1*a.bandwidth()}).attr("height",function(e){return m[e.level].range()[1]-m[e.level].range()[0]}),v.append("text").merge(i.select("text")).style("cursor","grab").style("-webkit-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").text(function(e){return"__seqId"===e.attrib?"sequential Index":e.attrib}).attr("x",a.bandwidth()/2).attr("y",0).style("font-weight",function(e){return g.has(e.level)&&g.get(e.level)===e.attrib?"bolder":"normal"}).style("font-family","sans-serif").style("font-size",c.attribFontSize+"px").on("click",I).call(e.drag().container(v.merge(i).node()).on("start",M).on("drag",W).on("end",V)).on("mousemove",function(){var t=e.select(this);(t=void 0!==t.transition?t.transition().duration(150):t).style("font-size",c.attribFontSizeSelected+"px")}).on("mouseout",function(){var t=e.select(this);(t=void 0!==t.transition?t.transition().duration(150):t).style("font-size",c.attribFontSize+"px")}).attr("transform","rotate(-45)"),o.append("text").attr("class","numNodesLabel").style("font-family","sans-serif").style("pointer-events","none").merge(n.select(".numNodesLabel")).attr("y",function(e,t){return m[t].range()[1]+15}).attr("x",function(e,t){return r(t)}).text(function(e){return _(e.length)}),i.exit().remove(),n.exit().remove(),h=u.length-1,T.select("#closeButton").style("display",1===u.length?"none":"block").attr("transform","translate("+(r(h)+r.bandwidth()-c.levelsSeparation+15)+","+m[h].range()[0]+")");var k=performance.now();console.log("Redrawing "+(k-x)+"ms")},c.addAttrib=function(e,t){if(-1===p.indexOf(e))return p.push(e),y.set(e,t),c},c.addSequentialAttrib=function(t,n){return c.addAttrib(t,n||e.scaleSequential(x).domain(void 0!==d&&d.length>0?e.extent(d,function(e){return e[t]}):[0,1])),c},c.addCategoricalAttrib=function(t,n){return c.addAttrib(t,n||e.scaleOrdinal(e.schemeCategory10)),c},c.data=function(t){return y.has("visible")||(c.addAttrib("visible",e.scaleOrdinal().domain([!1,!0]).range(w)),R("visible",0)),y.has("__seqId")||(c.addSequentialAttrib("__seqId"),R("__seqId",1)),arguments.length?(t.forEach(function(e){e.visible=!0}),u=[(d=t).map(function(e,t){return t})],c.initData(u,y),c.updateData(u,y),c):d[0]},c.getVisible=function(){return u[u.length-1].filter(function(e){return d[e].visible}).map(function(e){return d[e]})},c.updateCallback=function(e){return arguments.length?(A=e,c):A},c.visibleColorRange=function(e){return arguments.length?(w=e,c):w},c.defaultColorInterpolator=function(e){return arguments.length?(x=e,c):x},c.id=function(e){return arguments.length?(C=e,c):C},c}});
