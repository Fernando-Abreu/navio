// https://github.com/john-guerra/Navio#readme v0.0.16 Copyright 2019 John Alexis Guerra GÃ³mez
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("d3-scale-chromatic")):"function"==typeof define&&define.amd?define(["d3","d3-scale-chromatic"],t):e.navio=t(e.d3,e.d3ScaleChromatic)}(this,function(e,t){"use strict";class n{constructor(e){this.first=e.first,this.last=e.last,this.level=e.level}filter(e){return e.__i[this.level]>=this.first.__i[this.level]&&e.__i[this.level]<=this.last.__i[this.level]}}class o{constructor(e){this.itemAttr=e.itemAttr,this.sel=e.sel}filter(e){return e[this.itemAttr]===this.sel[this.itemAttr]}}return function(a,r){var l,i,s,c,d,u=this||{},f=[],v=[],p=e.map(),g=e.map(),h=[],m=[],y=[],b=[],x=[],_=void 0!==r?r:600,w=e.map(),S="interpolateBlues"in e?e.interpolateBlues:t.interpolateBlues,A="interpolatePurples"in e?e.interpolatePurples:t.interpolatePurples,k="interpolateBrBG"in e?e.interpolateBrBG:t.interpolateBrBG,C=["white","#b5cf6b"],T=e.format(",.0d"),E=0,D=100,P="__seqId",q=function(){};function O(){console.log("nozoom"),e.event.preventDefault()}u.margin=10,u.attribWidth=15,u.levelsSeparation=40,u.divisionsColor="white",u.levelConvectionsColor="rgba(205, 220, 163, 0.5)",u.divisionsThreshold=4,u.attribFontSize=13,u.attribFontSizeSelected=32,u.startColor="white",u.endColor="red",u.legendFont="14px Arial",u.linkColor="#2171b5",(a=void 0===(a="string"==typeof a?e.select(a):a).selectAll?e.select(a):a).selectAll("*").remove(),a.on("touchstart",O).on("touchmove",O).style("height",_+"px").attr("class","navio").append("div").attr("id","navio").style("position","relative"),a.select("#navio").append("canvas");var z=a.select("#navio").append("svg").style("overflow","visible").style("position","absolute").style("z-index",99).style("top",0).style("left",0);z.append("g").attr("class","attribs"),z.append("g").attr("class","nvTooltip").style("text-shadow","0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff").attr("transform","translate(-100,-10)").append("text").attr("x",0).attr("y",0).style("pointer-events","none").style("font-family","sans-serif").style("font-size","16pt").style("text-anchor","middle"),z.select(".nvTooltip > text").append("tspan").attr("class","tool_id").attr("x",0).attr("dy","1.2em"),z.select(".nvTooltip > text").append("tspan").attr("class","tool_value_name").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),z.select(".nvTooltip > text").append("tspan").attr("class","tool_value_val").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),z.append("g").attr("id","closeButton").style("fill","white").style("stroke","black").style("display","none").append("path").call(function(t){var n=e.path();n.moveTo(0,0),n.lineTo(7,7),n.moveTo(7,0),n.lineTo(0,7),n.moveTo(11.9,3.5),n.arc(3.5,3.5,8.4,0,2*Math.PI),t.attr("d",n.toString())}).on("click",function(){v.length<=1||(console.log("Delete one level"),M(v.length-2),v[v.length-2].forEach(function(e){f[e].visible=!0}),v=v.slice(0,v.length-1),u.updateData(v,w),q(u.getVisible()))}),l=e.scaleBand().range([0,u.attribWidth]).round(!0).paddingInner(.1).paddingOuter(0),s=e.scaleBand().round(!0),w=e.map(),i=function(e,t){return s(t)+l(e)},(c=a.select("canvas").node()).style.top=c.offsetTop+"px",c.style.left=c.offsetLeft+"px",c.style.height=_+"px";const B=window.devicePixelRatio;function I(t,n){var o=t.domain(),a=t.range();return e.scaleQuantize().domain(a).range(o)(n)}function F(t){e.event&&e.event.defaultPrevented||(console.log("click "+t),m[t.level]=t.attrib,Q(t.level),M(t.level),u.updateData(v,w,t.level))}function M(t){e.select("#level"+t).selectAll(".brush").call(y[t].move,null)}function W(e){for(var t=0;t<v.length;t+=1)t!==e&&M(t)}function N(t,a){y[a]=e.brushY().extent([[i(l.domain()[0],a),x[a].range()[0]],[i(l.domain()[l.domain().length-1],a)+1.1*l.bandwidth(),x[a].range()[1]]]).on("end",function(){if(!e.event.sourceEvent)return;if(!e.event.selection)return void console.log("Empty selection",e.event.selection,e.event.type,e.event.sourceEvent);W(a);var t=performance.now(),o=e.event.selection,r=p.get(I(x[a],o[0])),l=p.get(I(x[a],o[1]));const i=new n({first:r,last:l,level:a});e.event.sourceEvent.shiftKey?b[a].push(i):b[a]=[i];var s=d();c(s);var f=performance.now();console.log("Brushend filtering "+(f-t)+"ms"),console.log("Computing new data");var g=v;0!==s.length?((g=v.slice(0,a+1)).push(s),u.updateData(g,w),console.log("out of updateData"),console.log("Selected "+s.length+" calling updateCallback"),q(u.getVisible())):console.log("Empty selection!")});var r=e.select(this).selectAll(".brush").data([{data:f[t],level:a}]);function c(e){for(var t=0;t<e.length;t++)f[e[t]].__i[a+1]=t}function d(){let e,t;console.log("applyFilters ",b),e=performance.now();var n=v[a].filter(e=>{f[e].visible=!1;for(let t of b[a])if(t.filter(f[e])){f[e].visible=!0;break}return f[e].visible});return t=performance.now(),console.log("Applying filters "+(t-e)+"ms"),n}r.enter().merge(r).append("g").on("mousemove",V).on("click",function(){console.log("click");var t=e.mouse(e.event.target)[1];!function(t,n){console.log("onSelectByValueFromCoords",t,n),W(-1);var r=performance.now(),i=I(x[a],n),f=performance.now();console.log("invertOrdinalScale "+(f-r)+"ms");var g=I(l,t-s(a));if(void 0===g)return;var h=p.get(i);const m=new o({sel:h,itemAttr:g});e.event.shiftKey?b[a].push(m):b[a]=[m];var y=d();c(y);var _=v.slice(0,a+1);_.push(y),u.updateData(_,w),console.log("Selected "+u.getVisible().length+" calling updateCallback"),q(u.getVisible())}(e.mouse(e.event.target)[0],t)}).on("mouseout",K).attr("class","brush").call(y[a]).selectAll("rect").attr("width",i(l.domain()[l.domain().length-1],a)+1.1*l.bandwidth()),r.exit().remove()}function V(t){var n=e.mouse(e.event.target)[1],o=e.mouse(e.event.target)[0],a=I(x[t.level],n),r=I(l,o-s(t.level)),i=p.get(a);z.select(".nvTooltip").attr("transform","translate("+o+","+(n+20)+")").call(function(e){e.select(".tool_id").text(a),e.select(".tool_value_name").text(r+" : "),e.select(".tool_value_val").text(i[r])})}function K(){z.select(".nvTooltip").attr("transform","translate(-200,-200)").call(function(e){e.select(".tool_id").text(""),e.select(".tool_value_name").text(""),e.select(".tool_value_val").text("")})}function U(t){var n=l.domain(),o=z.select(".attribs").selectAll(".levelOverlay").data(v),a=o.enter().append("g");a.attr("class","levelOverlay").attr("id",function(e,t){return"level"+t}),t?a.merge(o).each(N):a.each(N);var r=a.merge(o).selectAll(".attribOverlay").data(function(e,t){return n.map(function(e){return{attrib:e,level:t}})}),c=r.enter().append("g").attr("class","attribOverlay").style("cursor","pointer");c.merge(r).attr("transform",function(e){return"translate("+i(e.attrib,e.level)+","+x[e.level].range()[0]+")"}),c.append("rect").merge(r.select("rect")).attr("fill","none").attr("x",0).attr("y",0).attr("width",function(){return 1.1*l.bandwidth()}).attr("height",function(e){return x[e.level].range()[1]-x[e.level].range()[0]}),c.append("text").merge(r.select("text")).style("cursor","point").style("-webkit-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").text(function(e){return"__seqId"===e.attrib?"sequential Index":e.attrib}).attr("x",l.bandwidth()/2).attr("y",0).style("font-weight",function(e){return m.hasOwnProperty(e.level)&&m[e.level]===e.attrib?"bolder":"normal"}).style("font-family","sans-serif").style("font-size",u.attribFontSize+"px").on("click",F).call(e.drag().container(c.merge(r).node()).on("start",L).on("drag",R).on("end",G)).on("mousemove",function(){var t=e.select(this);(t=void 0!==t.transition?t.transition().duration(150):t).style("font-size",u.attribFontSizeSelected+"px")}).on("mouseout",function(){var t=e.select(this);(t=void 0!==t.transition?t.transition().duration(150):t).style("font-size",u.attribFontSize+"px")}).attr("transform","rotate(-45)"),a.append("text").merge(o.select("text.numNodesLabel")).attr("class","numNodesLabel").style("font-family","sans-serif").style("pointer-events","none").merge(o.select(".numNodesLabel")).attr("y",function(e,t){return x[t].range()[1]+15}).attr("x",function(e,t){return s(t)}).text(function(e){return T(e.length)}),r.exit().remove(),o.exit().remove()}function L(t){e.event.sourceEvent.shiftKey&&(console.log("start",t),e.select(this.parentNode).attr("transform",function(t){return"translate("+(e.event.x+u.attribFontSize/2)+","+x[t.level].range()[0]+")"}))}function R(t){e.event.sourceEvent.shiftKey&&e.select(this.parentNode).attr("transform",function(t){return"translate("+(e.event.x+u.attribFontSize/2)+","+x[t.level].range()[0]+")"})}function G(t){if(e.event.sourceEvent.shiftKey){console.log("end",t);var n,o=I(l,e.event.x+u.attribFontSize/2-s(t.level));e.select(this.parentNode).attr("transform",function(e){return"translate("+i(e.attrib,e.level)+","+x[e.level].range()[0]+")"}),o!==t.attrib&&(n=h.indexOf(o),Y(t.attrib,n),u.updateData(v))}}function j(e,t,n,o){d.beginPath(),e.forEach(function(e,t){0===t?d.moveTo(e.x,e.y):d.lineTo(e.x,e.y)}),d.lineWidth=t,o?(d.fillStyle=n,d.closePath(),d.fill()):(d.strokeStyle=n,d.stroke())}function Q(t){if(!m.hasOwnProperty(t))return void console.log("UpdateSorting called without attrib in dSortBy",t,m);var n=performance.now();const o=m[t];v[t]=v[t].sort(function(t,n){return e.ascending(f[t][o],f[n][o])}),v[t].forEach(function(e,n){f[e].__i[t]=n});var a=performance.now();console.log("Sorting level "+t+" "+(a-n)+"ms")}function Y(e,t){var n=h.indexOf(e);-1!==n?t>h.length||t<0?console.err("moveAttrToPos pos out of bounds",t,h.length):(h.splice(n,1),h.splice(t,0,e)):console.err("moveAttrToPos attr not found",e)}return c.height=_*B,(d=c.getContext("2d")).scale(B,B),d.imageSmoothingEnabled=d.mozImageSmoothingEnabled=d.webkitImageSmoothingEnabled=!1,d.globalCompositeOperation="source-over",u.initData=function(t,n){var o=performance.now();(w=n).keys().forEach(function(e){g.set(e,!0)}),p=e.map();for(var a=0;a<f.length;a++){var r=f[a];r.__seqId=a,p.set(r[P],r),r.__i={},r.__i[0]=a}(b=[])[0]=[];var l=performance.now();console.log("Init data "+(l-o)+"ms")},u.updateData=function(t,n,o){console.log("updateData");var a,r=performance.now();if(typeof t==typeof[]){w=void 0!==n?n:w,v=t,b.splice(t.length),b[t.length]=[],y.splice(t.length),Q(t.length-1),function(t){console.log("Update scales");var n=performance.now(),o=v.length-1;console.log("Delete unvecessary scales"),x.splice(o+1,x.length),x[t=void 0!==t?t:o]=e.scaleBand().range([D,_-u.margin-30]).paddingInner(0).paddingOuter(0),console.log("Compute representatives");var a=[];if(v[t].length>_){var r=Math.max(Math.floor(v[t].length/(2*_)),1);console.log("itemsPerpixel",r),v[t].itemsPerpixel=r;for(var i=0;i<v[t].length;i+=r)a.push(v[t][i])}else v[t].itemsPerpixel=1,a=v[t];v[t].representatives=a,x[t].domain(a.map(function(e){return f[e][P]})),console.log("Update color scale domains"),g.keys().forEach(function(t){if("visible"!==t){var n=w.get(t);if("seq"===n.__type||"date"===n.__type)n.domain(e.extent(v[0].map(function(e){return f[e][t]})));else if("div"===n.__type){const[o,a]=e.extent(v[0].map(function(e){return f[e][t]})),r=Math.max(-o,a);n.domain([-r,r])}w.set(t,n)}}),l.domain(h).range([0,u.attribWidth*g.keys().length]).paddingInner(.1).paddingOuter(0),s.domain(v.map(function(e,t){return t})).range([E+u.margin,(l.range()[1]+u.levelsSeparation)*v.length+E]).paddingInner(0).paddingOuter(0);var c=performance.now();console.log("Updating Scales "+(c-n)+"ms")}(o),a=s.range()[1]+u.margin+E,e.select(c).attr("width",a).attr("height",_).style("width",a).style("height",_+"px"),c.style.width=a+"px",c.style.height=_+"px",z.attr("width",a).attr("height",_),u.update();var i=performance.now();console.log("Updating data "+(i-r)+"ms")}else console.error("navio updateData didn't receive an array")},u.update=function(e){var t,n=void 0!==e&&e,o=performance.now(),a=s.range()[1]+u.margin+E;d.clearRect(0,0,a+1,_+1),v.forEach(function(e,t){var n;!function(e){d.beginPath(),d.rect(s(e),x[e].range()[0]-1,l.range()[1]+1,x[e].range()[1]+2-100),d.strokeStyle="black",d.lineWidth=1,d.stroke()}(t),e.representatives.forEach(function(e){!function(e,t){var n,o,a;for(x[t].bandwidth()>u.divisionsThreshold&&console.log("Add borders"),o=0;o<h.length;o++)if(n=h[o],a=Math.round(x[t](e[P])+x[t].bandwidth()/2),d.beginPath(),d.moveTo(Math.round(i(n,t)),a),d.lineTo(Math.round(i(n,t)+l.bandwidth()),a),d.lineWidth=Math.ceil(x[t].bandwidth())+1,d.strokeStyle=void 0===e[n]||null===e[n]||""===e[n]||"none"===e[n]?"white":w.get(n)(e[n]),d.stroke(),x[t].bandwidth()>2*u.divisionsThreshold){var r=Math.round(x[t](e[P]));d.beginPath(),d.moveTo(i(n,t),r),d.lineTo(i(n,t)+l.bandwidth(),r),d.lineWidth=1,d.strokeStyle=u.divisionsColor,d.stroke()}}(f[e],t)}),(n=t)<=0||v[n].representatives.forEach(function(e){var t=p.get(f[e][P]).__i[n-1],o=Math.floor(t-t%v[n-1].itemsPerpixel),a={x:s(n-1)+l.range()[1],y:x[n-1](f[v[n-1][o]][P])},r={x:s(n),y:x[n](f[e][P])},i=[a,{x:a.x+.3*u.levelsSeparation,y:a.y},{x:r.x-.3*u.levelsSeparation,y:r.y},r,{x:r.x,y:r.y+x[n].bandwidth()},{x:r.x-.3*u.levelsSeparation,y:r.y+x[n].bandwidth()},{x:a.x+.3*u.levelsSeparation,y:a.y+x[n-1].bandwidth()},{x:a.x,y:a.y+x[n-1].bandwidth()},a];j(i,1,u.levelConvectionsColor),j(i,1,u.levelConvectionsColor,!0)})}),U(n),t=v.length-1,z.select("#closeButton").style("display",1===v.length?"none":"block").attr("transform","translate("+(s(t)+s.bandwidth()-u.levelsSeparation+15)+","+x[t].range()[0]+")");var r=performance.now();console.log("Redrawing "+(r-o)+"ms")},u.addAttrib=function(e,t){if(-1===h.indexOf(e))return h.push(e),w.set(e,t),u},u.addSequentialAttrib=function(t,n){const o=void 0!==f&&f.length>0?e.extent(f,function(e){return e[t]}):[0,1],a=n||e.scaleSequential(S).domain(o);return a.__type="seq",u.addAttrib(t,a),u},u.addDateAttrib=function(t,n){const o=void 0!==f&&f.length>0?e.extent(f,function(e){return e[t]}):[0,1],a=n||e.scaleSequential(A).domain(o);return u.addAttrib(t,a),a.__type="date",u},u.addDivergingAttrib=function(t,n){const o=void 0!==f&&f.length>0?e.extent(f,function(e){return e[t]}):[-1,1],a=n||e.scaleSequential(k).domain([o[0],o[1]]);return a.__type="div",u.addAttrib(t,a),u},u.addCategoricalAttrib=function(t,n){const o=n||e.scaleOrdinal(e.schemeCategory10);return o.__type="cat",u.addAttrib(t,o),u},u.addAllAttribs=function(t){if(!f||!f.length)throw Error("addAllAttribs called without data to guess the attribs. Make sure to call it after setting the data");return(void 0!==t?t:function(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push(t);return n}(f[0])).forEach(function(t){"__seqId"!==t&&"__i"!==t&&("string"==typeof f[0][t]?u.addCategoricalAttrib(t):typeof f[0][t]==typeof new Date?u.addDateAttrib(t):"number"==typeof f[0][t]&&e.min(f,e=>e[t])<0?u.addDivergingAttrib(t):u.addSequentialAttrib(t))}),u.data(f),U(!0),u},u.data=function(t){return w.has("visible")||(u.addAttrib("visible",e.scaleOrdinal().domain([!1,!0]).range(C)),Y("visible",0)),w.has("__seqId")||(u.addSequentialAttrib("__seqId"),Y("__seqId",1)),arguments.length?(t.forEach(function(e){e.visible=!0}),v=[(f=t).map(function(e,t){return t})],u.initData(v,w),u.updateData(v,w),u):f[0]},u.getVisible=function(){return v[v.length-1].filter(function(e){return f[e].visible}).map(function(e){return f[e]})},u.updateCallback=function(e){return arguments.length?(q=e,u):q},u.visibleColorRange=function(e){return arguments.length?(C=e,u):C},u.defaultColorInterpolator=function(e){return arguments.length?(S=e,u):S},u.id=function(e){return arguments.length?(P=e,u):P},u}});
