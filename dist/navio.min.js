// https://github.com/john-guerra/Navio#readme v0.0.20 Copyright 2019 John Alexis Guerra Gómez
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("d3-scale-chromatic")):"function"==typeof define&&define.amd?define(["d3","d3-scale-chromatic"],t):e.navio=t(e.d3,e.d3ScaleChromatic)}(this,function(e,t){"use strict";class n{constructor(e){this.first=e.first,this.last=e.last,this.level=e.level}filter(e){return e.__i[this.level]>=this.first.__i[this.level]&&e.__i[this.level]<=this.last.__i[this.level]}}class o{constructor(e){this.itemAttr=e.itemAttr,this.sel=e.sel}filter(e){return e[this.itemAttr]===this.sel[this.itemAttr]}}return function(r,l){var a,i,s,c,d,u=this||{},f=[],v=[],h=[],g=[],p=e.map(),m=e.map(),b=[],y=[],x=[],w=[],_=[],S=void 0!==l?l:600,A=e.map(),k="interpolateBlues"in e?e.interpolateBlues:t.interpolateBlues,C="interpolatePurples"in e?e.interpolatePurples:t.interpolatePurples,T="interpolateBrBG"in e?e.interpolateBrBG:t.interpolateBrBG,E=["white","#b5cf6b"],D=e.format(",.0d"),P=0,q=100,I="__seqId",z=function(){};function B(){console.log("nozoom"),e.event.preventDefault()}u.howManyItemsShouldSearchForNotNull=100,u.margin=10,u.attribWidth=15,u.levelsSeparation=40,u.divisionsColor="white",u.levelConvectionsColor="rgba(205, 220, 163, 0.5)",u.divisionsThreshold=4,u.attribFontSize=13,u.attribFontSizeSelected=32,u.startColor="white",u.endColor="red",u.legendFont="14px Arial",u.linkColor="#2171b5",(r=void 0===(r="string"==typeof r?e.select(r):r).selectAll?e.select(r):r).selectAll("*").remove(),r.on("touchstart",B).on("touchmove",B).style("height",S+"px").attr("class","navio").append("div").attr("id","navio").style("position","relative"),r.select("#navio").append("canvas");var M=r.select("#navio").append("svg").style("overflow","visible").style("position","absolute").style("z-index",99).style("top",0).style("left",0);M.append("g").attr("class","attribs"),M.append("g").attr("class","nvTooltip").style("text-shadow","0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff").attr("transform","translate(-100,-10)").append("text").attr("x",0).attr("y",0).style("pointer-events","none").style("font-family","sans-serif").style("font-size","16pt").style("text-anchor","middle"),M.select(".nvTooltip > text").append("tspan").attr("class","tool_id").attr("x",0).attr("dy","1.2em"),M.select(".nvTooltip > text").append("tspan").attr("class","tool_value_name").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),M.select(".nvTooltip > text").append("tspan").attr("class","tool_value_val").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),M.append("g").attr("id","closeButton").style("fill","white").style("stroke","black").style("display","none").append("path").call(function(t){var n=e.path();n.moveTo(0,0),n.lineTo(7,7),n.moveTo(7,0),n.lineTo(0,7),n.moveTo(11.9,3.5),n.arc(3.5,3.5,8.4,0,2*Math.PI),t.attr("d",n.toString())}).on("click",function(){v.length<=1||(console.log("Delete one level"),K(v.length-2),v[v.length-2].forEach(function(e){f[e].visible=!0}),v=v.slice(0,v.length-1),u.updateData(v,A),z(u.getVisible()))}),a=e.scaleBand().range([0,u.attribWidth]).round(!0).paddingInner(.1).paddingOuter(0),s=e.scaleBand().round(!0),A=e.map(),i=function(e,t){return s(t)+a(e)},(c=r.select("canvas").node()).style.top=c.offsetTop+"px",c.style.left=c.offsetLeft+"px",c.style.height=S+"px";const O=window.devicePixelRatio;function N(t){e.select(t).style("cursor","progress"),M.style("cursor","progress")}function F(t){e.select(t).style("cursor",null),M.style("cursor",null)}function W(t,n){var o=t.domain(),r=t.range();return e.scaleQuantize().domain(r).range(o)(n)}function V(t){e.event&&e.event.defaultPrevented||(console.log("click "+t),N(this),y[t.level]={attrib:t.attrib,reverse:void 0!==y[t.level]&&y[t.level].attrib===t.attrib&&!y[t.level].reverse},Z(t.level),K(t.level),u.updateData(v,A,t.level))}function K(t){e.select("#level"+t).selectAll(".brush").call(x[t].move,null)}function U(e){for(var t=0;t<v.length;t+=1)t!==e&&K(t)}function L(t,r){x[r]=e.brushY().extent([[i(a.domain()[0],r),_[r].range()[0]],[i(a.domain()[a.domain().length-1],r)+1.1*a.bandwidth(),_[r].range()[1]]]).on("end",function(){if(N(this),!e.event.sourceEvent)return;if(!e.event.selection)return void console.log("Empty selection",e.event.selection,e.event.type,e.event.sourceEvent);U(r);var t=performance.now(),o=e.event.selection,l=p.get(W(_[r],o[0])),a=p.get(W(_[r],o[1]));const i=new n({first:l,last:a,level:r});e.event.sourceEvent.shiftKey?w[r].push(i):w[r]=[i];var s=d();c(s);var f=performance.now();console.log("Brushend filtering "+(f-t)+"ms"),console.log("Computing new data");var h=v;0!==s.length?((h=v.slice(0,r+1)).push(s),u.updateData(h,A),console.log("out of updateData"),console.log("Selected "+s.length+" calling updateCallback"),z(u.getVisible()),F(this)):console.log("Empty selection!")});var l=e.select(this).selectAll(".brush").data([{data:f[t],level:r}]);function c(e){for(var t=0;t<e.length;t++)f[e[t]].__i[r+1]=t}function d(){let e,t;console.log("applyFilters ",w),e=performance.now();var n=v[r].filter(e=>{f[e].visible=!1;for(let t of w[r])if(t.filter(f[e])){f[e].visible=!0;break}return f[e].visible});return t=performance.now(),console.log("Applying filters "+(t-e)+"ms"),n}l.enter().merge(l).append("g").on("mousemove",R).on("click",function(){console.log("click"),N(this);var t=e.mouse(e.event.target)[1];(function(t,n){console.log("onSelectByValueFromCoords",t,n),U(-1);var l=performance.now(),i=W(_[r],n),f=performance.now();console.log("invertOrdinalScale "+(f-l)+"ms");var h=W(a,t-s(r));if(void 0===h)return;var g=p.get(i);const m=new o({sel:g,itemAttr:h});e.event.shiftKey?w[r].push(m):w[r]=[m];var b=d();c(b);var y=v.slice(0,r+1);y.push(b),u.updateData(y,A),console.log("Selected "+u.getVisible().length+" calling updateCallback"),z(u.getVisible())})(e.mouse(e.event.target)[0],t),F(this)}).on("mouseout",G).attr("class","brush").call(x[r]).selectAll("rect").attr("width",i(a.domain()[a.domain().length-1],r)+1.1*a.bandwidth()),l.exit().remove()}function R(t){var n=e.mouse(e.event.target)[1],o=e.mouse(e.event.target)[0],r=W(_[t.level],n),l=W(a,o-s(t.level)),i=p.get(r);M.select(".nvTooltip").attr("transform","translate("+o+","+(n+20)+")").call(function(e){e.select(".tool_id").text(r),e.select(".tool_value_name").text(l+" : "),e.select(".tool_value_val").text(i[l])})}function G(){M.select(".nvTooltip").attr("transform","translate(-200,-200)").call(function(e){e.select(".tool_id").text(""),e.select(".tool_value_name").text(""),e.select(".tool_value_val").text("")})}function j(t){var n=a.domain(),o=M.select(".attribs").selectAll(".levelOverlay").data(v),r=o.enter().append("g");r.attr("class","levelOverlay").attr("id",function(e,t){return"level"+t}),t?r.merge(o).each(L):r.each(L);var l,c=r.merge(o).selectAll(".attribOverlay").data(function(e,t){return n.map(function(e){return{attrib:e,level:t}})}),d=c.enter().append("g").attr("class","attribOverlay").style("cursor","pointer");d.merge(c).attr("transform",function(e){return"translate("+i(e.attrib,e.level)+","+_[e.level].range()[0]+")"}),d.append("rect").merge(c.select("rect")).attr("fill","none").attr("x",0).attr("y",0).attr("width",function(){return 1.1*a.bandwidth()}).attr("height",function(e){return _[e.level].range()[1]-_[e.level].range()[0]}),d.append("text").merge(c.select("text")).style("cursor","point").style("-webkit-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").text(function(e){return"__seqId"===e.attrib?"sequential Index":e.attrib+(void 0!==y[e.level]&&y[e.level].attrib===e.attrib?y[e.level].reverse?" ↓":" ↑":"")}).attr("x",a.bandwidth()/2).attr("y",0).style("font-weight",function(e){return void 0!==y[e.level]&&y[e.level].attrib===e.attrib?"bolder":"normal"}).style("font-family","sans-serif").style("font-size",u.attribFontSize+"px").on("click",(l=V,function(e,t,n){N(this),setTimeout(()=>{l(e,t,n),F(this)},100)})).call(e.drag().container(d.merge(c).node()).on("start",Q).on("drag",Y).on("end",H)).on("mousemove",function(){var t=e.select(this);(t=void 0!==t.transition?t.transition().duration(150):t).style("font-size",u.attribFontSizeSelected+"px")}).on("mouseout",function(){var t=e.select(this);(t=void 0!==t.transition?t.transition().duration(150):t).style("font-size",u.attribFontSize+"px")}).attr("transform","rotate(-45)"),r.append("text").merge(o.select("text.numNodesLabel")).attr("class","numNodesLabel").style("font-family","sans-serif").style("pointer-events","none").merge(o.select(".numNodesLabel")).attr("y",function(e,t){return _[t].range()[1]+15}).attr("x",function(e,t){return s(t)}).text(function(e){return D(e.length)}),c.exit().remove(),o.exit().remove()}function Q(t){e.event.sourceEvent.shiftKey&&(console.log("start",t),e.select(this.parentNode).attr("transform",function(t){return"translate("+(e.event.x+u.attribFontSize/2)+","+_[t.level].range()[0]+")"}))}function Y(t){e.event.sourceEvent.shiftKey&&e.select(this.parentNode).attr("transform",function(t){return"translate("+(e.event.x+u.attribFontSize/2)+","+_[t.level].range()[0]+")"})}function H(t){if(e.event.sourceEvent.shiftKey){console.log("end",t);var n,o=W(a,e.event.x+u.attribFontSize/2-s(t.level));e.select(this.parentNode).attr("transform",function(e){return"translate("+i(e.attrib,e.level)+","+_[e.level].range()[0]+")"}),o!==t.attrib&&(n=b.indexOf(o),$(t.attrib,n),u.updateData(v))}}function J(e){var t=a.domain()[a.domain().length-1],n=i(t,v.length-1)+a.bandwidth(),o=_[v.length-1](e.source[I])+_[v.length-1].bandwidth()/2,r=_[v.length-1](e.target[I])+_[v.length-1].bandwidth()/2,l=Math.min(o,r),s=Math.max(o,r),c=s-l;d.moveTo(n,l),d.quadraticCurveTo(n+c/6,l+c/2,n,s)}function X(e,t,n,o){d.beginPath(),e.forEach(function(e,t){0===t?d.moveTo(e.x,e.y):d.lineTo(e.x,e.y)}),d.lineWidth=t,o?(d.fillStyle=n,d.closePath(),d.fill()):(d.strokeStyle=n,d.stroke())}function Z(e){if(!y.hasOwnProperty(e))return void console.log("UpdateSorting called without attrib in dSortBy",e,y);var t=performance.now();const n=y[e];v[e]=v[e].sort(function(e,t){return n.reverse?function(e,t){return null===e?null===t?0:-1:t<e?-1:t>e?1:t>=e?0:NaN}(f[e][n.attrib],f[t][n.attrib]):function(e,t){return null===t?null===e?0:-1:e<t?-1:e>t?1:e>=t?0:NaN}(f[e][n.attrib],f[t][n.attrib])}),v[e].forEach(function(t,n){f[t].__i[e]=n});var o=performance.now();console.log("Sorting level "+e+" "+(o-t)+"ms")}function $(e,t){var n=b.indexOf(e);-1!==n?t>b.length||t<0?console.err("moveAttrToPos pos out of bounds",t,b.length):(b.splice(n,1),b.splice(t,0,e)):console.err("moveAttrToPos attr not found",e)}return c.height=S*O,(d=c.getContext("2d")).scale(O,O),d.imageSmoothingEnabled=d.mozImageSmoothingEnabled=d.webkitImageSmoothingEnabled=!1,d.globalCompositeOperation="source-over",u.initData=function(t,n){var o=performance.now();(A=n).keys().forEach(function(e){m.set(e,!0)}),p=e.map();for(var r=0;r<f.length;r++){var l=f[r];l.__seqId=r,p.set(l[I],l),l.__i={},l.__i[0]=r}(w=[])[0]=[];var a=performance.now();console.log("Init data "+(a-o)+"ms")},u.updateData=function(t,n,o){console.log("updateData");var r,l=performance.now();if(typeof t==typeof[]){A=void 0!==n?n:A,v=t,w.splice(t.length),w[t.length]=[],h.length>0&&(g=h.filter(function(e){return e.source.visible&&e.target.visible})),x.splice(t.length),Z(t.length-1),function(t){console.log("Update scales");var n=performance.now(),o=v.length-1;console.log("Delete unvecessary scales"),_.splice(o+1,_.length),_[t=void 0!==t?t:o]=e.scaleBand().range([q,S-u.margin-30]).paddingInner(0).paddingOuter(0),console.log("Compute representatives");var r=[];if(v[t].length>S){var l=Math.max(Math.floor(v[t].length/(2*S)),1);console.log("itemsPerpixel",l),v[t].itemsPerpixel=l;for(var i=0;i<v[t].length;i+=l)r.push(v[t][i])}else v[t].itemsPerpixel=1,r=v[t];v[t].representatives=r,_[t].domain(r.map(function(e){return f[e][I]})),console.log("Update color scale domains"),m.keys().forEach(function(t){if("visible"!==t){var n=A.get(t);if("seq"===n.__type||"date"===n.__type)n.domain(e.extent(v[0].map(function(e){return f[e][t]})));else if("div"===n.__type){const[o,r]=e.extent(v[0].map(function(e){return f[e][t]})),l=Math.max(-o,r);n.domain([-l,l])}A.set(t,n)}}),a.domain(b).range([0,u.attribWidth*m.keys().length]).paddingInner(.1).paddingOuter(0),s.domain(v.map(function(e,t){return t})).range([P+u.margin,(a.range()[1]+u.levelsSeparation)*v.length+P]).paddingInner(0).paddingOuter(0);var c=performance.now();console.log("Updating Scales "+(c-n)+"ms")}(o),r=s.range()[1]+u.margin+P,e.select(c).attr("width",r).attr("height",S).style("width",r).style("height",S+"px"),c.style.width=r+"px",c.style.height=S+"px",M.attr("width",r).attr("height",S),u.update();var i=performance.now();console.log("Updating data "+(i-l)+"ms")}else console.error("navio updateData didn't receive an array")},u.update=function(e){var t,n=void 0!==e&&e,o=performance.now(),r=s.range()[1]+u.margin+P;d.clearRect(0,0,r+1,S+1),v.forEach(function(e,t){var n;!function(e){d.beginPath(),d.rect(s(e),_[e].range()[0]-1,a.range()[1]+1,_[e].range()[1]+2-100),d.strokeStyle="black",d.lineWidth=1,d.stroke()}(t),e.representatives.forEach(function(e){!function(e,t){var n,o,r;for(_[t].bandwidth()>u.divisionsThreshold&&console.log("Add borders"),o=0;o<b.length;o++)if(n=b[o],r=Math.round(_[t](e[I])+_[t].bandwidth()/2),d.beginPath(),d.moveTo(Math.round(i(n,t)),r),d.lineTo(Math.round(i(n,t)+a.bandwidth()),r),d.lineWidth=Math.ceil(_[t].bandwidth())+1,d.strokeStyle=void 0===e[n]||null===e[n]||""===e[n]||"none"===e[n]?"white":A.get(n)(e[n]),d.stroke(),_[t].bandwidth()>2*u.divisionsThreshold){var l=Math.round(_[t](e[I]));d.beginPath(),d.moveTo(i(n,t),l),d.lineTo(i(n,t)+a.bandwidth(),l),d.lineWidth=1,d.strokeStyle=u.divisionsColor,d.stroke()}}(f[e],t)}),(n=t)<=0||v[n].representatives.forEach(function(e){var t=p.get(f[e][I]).__i[n-1],o=Math.floor(t-t%v[n-1].itemsPerpixel),r={x:s(n-1)+a.range()[1],y:_[n-1](f[v[n-1][o]][I])},l={x:s(n),y:_[n](f[e][I])},i=[r,{x:r.x+.3*u.levelsSeparation,y:r.y},{x:l.x-.3*u.levelsSeparation,y:l.y},l,{x:l.x,y:l.y+_[n].bandwidth()},{x:l.x-.3*u.levelsSeparation,y:l.y+_[n].bandwidth()},{x:r.x+.3*u.levelsSeparation,y:r.y+_[n-1].bandwidth()},{x:r.x,y:r.y+_[n-1].bandwidth()},r];X(i,1,u.levelConvectionsColor),X(i,1,u.levelConvectionsColor,!0)})}),console.log("Draw links ",h[h.length-1].length,h),h.length&&(d.save(),d.beginPath(),d.strokeStyle=u.linkColor,d.globalAlpha=Math.min(1,Math.max(.1,1e3/h[h.length-1].length)),g.forEach(J),d.stroke(),d.restore()),j(n),t=v.length-1,M.select("#closeButton").style("display",1===v.length?"none":"block").attr("transform","translate("+(s(t)+s.bandwidth()-u.levelsSeparation+15)+","+_[t].range()[0]+")");var l=performance.now();console.log("Redrawing "+(l-o)+"ms")},u.addAttrib=function(e,t){if(-1===b.indexOf(e))return b.push(e),A.set(e,t),u},u.addSequentialAttrib=function(t,n){const o=void 0!==f&&f.length>0?e.extent(f,function(e){return e[t]}):[0,1],r=n||e.scaleSequential(k).domain(o);return r.__type="seq",u.addAttrib(t,r),u},u.addDateAttrib=function(t,n){const o=void 0!==f&&f.length>0?e.extent(f,function(e){return e[t]}):[0,1],r=n||e.scaleSequential(C).domain(o);return u.addAttrib(t,r),r.__type="date",u},u.addDivergingAttrib=function(t,n){const o=void 0!==f&&f.length>0?e.extent(f,function(e){return e[t]}):[-1,1],r=n||e.scaleSequential(T).domain([o[0],o[1]]);return r.__type="div",u.addAttrib(t,r),u},u.addCategoricalAttrib=function(t,n){const o=n||e.scaleOrdinal(e.schemeCategory10);return o.__type="cat",u.addAttrib(t,o),u},u.addAllAttribs=function(t){if(!f||!f.length)throw Error("addAllAttribs called without data to guess the attribs. Make sure to call it after setting the data");return(void 0!==t?t:function(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push(t);return n}(f[0])).forEach(function(t){if("__seqId"===t||"__i"===t)return;const n=function(e,t){let n;for(n=0;n<u.howManyItemsShouldSearchForNotNull&&n<e.length;n++)if(null!==e[0][t]&&void 0!==e[0][t]&&""!==e[0][t])return e[n][t];return e[n][t]}(f,t);null==n||""===n?u.addCategoricalAttrib(t):"number"==typeof n?e.min(f,e=>e[t])<0?u.addDivergingAttrib(t):u.addSequentialAttrib(t):typeof n==typeof new Date?u.addDateAttrib(t):u.addCategoricalAttrib(t)}),u.data(f),j(!0),u},u.data=function(t){return A.has("visible")||(u.addAttrib("visible",e.scaleOrdinal().domain([!1,!0]).range(E)),$("visible",0)),A.has("__seqId")||(u.addSequentialAttrib("__seqId"),$("__seqId",1)),arguments.length?(t.forEach(function(e){e.visible=!0}),v=[(f=t).map(function(e,t){return t})],u.initData(v,A),u.updateData(v,A),u):f[0]},u.getVisible=function(){return v[v.length-1].filter(function(e){return f[e].visible}).map(function(e){return f[e]})},u.updateCallback=function(e){return arguments.length?(z=e,u):z},u.visibleColorRange=function(e){return arguments.length?(E=e,u):E},u.defaultColorInterpolator=function(e){return arguments.length?(k=e,u):k},u.id=function(e){return arguments.length?(I=e,u):I},u.links=function(e){return arguments.length?(h=e,u):h},u}});
