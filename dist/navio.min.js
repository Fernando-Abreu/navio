// https://github.com/john-guerra/Navio#readme v0.0.18 Copyright 2019 John Alexis Guerra Gómez
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3"),require("d3-scale-chromatic")):"function"==typeof define&&define.amd?define(["d3","d3-scale-chromatic"],e):t.navio=e(t.d3,t.d3ScaleChromatic)}(this,function(t,e){"use strict";class n{constructor(t){this.first=t.first,this.last=t.last,this.level=t.level}filter(t){return t.__i[this.level]>=this.first.__i[this.level]&&t.__i[this.level]<=this.last.__i[this.level]}}class r{constructor(t){this.itemAttr=t.itemAttr,this.sel=t.sel}filter(t){return t[this.itemAttr]===this.sel[this.itemAttr]}}return function(a,i){var o,l,s,c,d,u=this||{},f=[],v=[],h=t.map(),p=t.map(),g=[],m=[],b=[],y=[],x=[],_=void 0!==i?i:600,w=t.map(),S="interpolateBlues"in t?t.interpolateBlues:e.interpolateBlues,A="interpolatePurples"in t?t.interpolatePurples:e.interpolatePurples,k="interpolateBrBG"in t?t.interpolateBrBG:e.interpolateBrBG,T=["white","#b5cf6b"],C=t.format(",.0d"),E=0,q=100,I="__seqId",P=function(){};function z(){t.event.preventDefault()}u.howManyItemsShouldSearchForNotNull=100,u.margin=10,u.attribWidth=15,u.levelsSeparation=40,u.divisionsColor="white",u.levelConvectionsColor="rgba(205, 220, 163, 0.5)",u.divisionsThreshold=4,u.attribFontSize=13,u.attribFontSizeSelected=32,u.startColor="white",u.endColor="red",u.legendFont="14px Arial",u.linkColor="#2171b5",(a=void 0===(a="string"==typeof a?t.select(a):a).selectAll?t.select(a):a).selectAll("*").remove(),a.on("touchstart",z).on("touchmove",z).style("height",_+"px").attr("class","navio").append("div").attr("id","navio").style("position","relative"),a.select("#navio").append("canvas");var D=a.select("#navio").append("svg").style("overflow","visible").style("position","absolute").style("z-index",99).style("top",0).style("left",0);D.append("g").attr("class","attribs"),D.append("g").attr("class","nvTooltip").style("text-shadow","0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff").attr("transform","translate(-100,-10)").append("text").attr("x",0).attr("y",0).style("pointer-events","none").style("font-family","sans-serif").style("font-size","16pt").style("text-anchor","middle"),D.select(".nvTooltip > text").append("tspan").attr("class","tool_id").attr("x",0).attr("dy","1.2em"),D.select(".nvTooltip > text").append("tspan").attr("class","tool_value_name").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),D.select(".nvTooltip > text").append("tspan").attr("class","tool_value_val").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),D.append("g").attr("id","closeButton").style("fill","white").style("stroke","black").style("display","none").append("path").call(function(e){var n=t.path();n.moveTo(0,0),n.lineTo(7,7),n.moveTo(7,0),n.lineTo(0,7),n.moveTo(11.9,3.5),n.arc(3.5,3.5,8.4,0,2*Math.PI),e.attr("d",n.toString())}).on("click",function(){v.length<=1||(W(v.length-2),v[v.length-2].forEach(function(t){f[t].visible=!0}),v=v.slice(0,v.length-1),u.updateData(v,w),P(u.getVisible()))}),o=t.scaleBand().range([0,u.attribWidth]).round(!0).paddingInner(.1).paddingOuter(0),s=t.scaleBand().round(!0),w=t.map(),l=function(t,e){return s(e)+o(t)},(c=a.select("canvas").node()).style.top=c.offsetTop+"px",c.style.left=c.offsetLeft+"px",c.style.height=_+"px";const O=window.devicePixelRatio;function B(e){t.select(e).style("cursor","progress"),D.style("cursor","progress")}function N(e){t.select(e).style("cursor",null),D.style("cursor",null)}function M(e,n){var r=e.domain(),a=e.range();return t.scaleQuantize().domain(a).range(r)(n)}function F(e){t.event&&t.event.defaultPrevented||(B(this),m[e.level]={attrib:e.attrib,reverse:void 0!==m[e.level]&&m[e.level].attrib===e.attrib&&!m[e.level].reverse},J(e.level),W(e.level),u.updateData(v,w,e.level))}function W(e){t.select("#level"+e).selectAll(".brush").call(b[e].move,null)}function K(t){for(var e=0;e<v.length;e+=1)e!==t&&W(e)}function L(e,a){b[a]=t.brushY().extent([[l(o.domain()[0],a),x[a].range()[0]],[l(o.domain()[o.domain().length-1],a)+1.1*o.bandwidth(),x[a].range()[1]]]).on("end",function(){if(B(this),!t.event.sourceEvent)return;if(!t.event.selection)return;K(a),performance.now();var e=t.event.selection,r=h.get(M(x[a],e[0])),i=h.get(M(x[a],e[1]));const o=new n({first:r,last:i,level:a});t.event.sourceEvent.shiftKey?y[a].push(o):y[a]=[o];var l=d();c(l),performance.now();var s=v;0!==l.length&&((s=v.slice(0,a+1)).push(l),u.updateData(s,w),P(u.getVisible()),N(this))});var i=t.select(this).selectAll(".brush").data([{data:f[e],level:a}]);function c(t){for(var e=0;e<t.length;e++)f[t[e]].__i[a+1]=e}function d(){let t,e;t=performance.now();var n=v[a].filter(t=>{f[t].visible=!1;for(let e of y[a])if(e.filter(f[t])){f[t].visible=!0;break}return f[t].visible});return e=performance.now(),n}i.enter().merge(i).append("g").on("mousemove",V).on("click",function(){B(this);var e=t.mouse(t.event.target)[1];(function(e,n){K(-1),performance.now();var i=M(x[a],n),l=(performance.now(),M(o,e-s(a)));if(void 0===l)return;var f=h.get(i);const p=new r({sel:f,itemAttr:l});t.event.shiftKey?y[a].push(p):y[a]=[p];var g=d();c(g);var m=v.slice(0,a+1);m.push(g),u.updateData(m,w),P(u.getVisible())})(t.mouse(t.event.target)[0],e),N(this)}).on("mouseout",G).attr("class","brush").call(b[a]).selectAll("rect").attr("width",l(o.domain()[o.domain().length-1],a)+1.1*o.bandwidth()),i.exit().remove()}function V(e){var n=t.mouse(t.event.target)[1],r=t.mouse(t.event.target)[0],a=M(x[e.level],n),i=M(o,r-s(e.level)),l=h.get(a);D.select(".nvTooltip").attr("transform","translate("+r+","+(n+20)+")").call(function(t){t.select(".tool_id").text(a),t.select(".tool_value_name").text(i+" : "),t.select(".tool_value_val").text(l[i])})}function G(){D.select(".nvTooltip").attr("transform","translate(-200,-200)").call(function(t){t.select(".tool_id").text(""),t.select(".tool_value_name").text(""),t.select(".tool_value_val").text("")})}function R(e){var n=o.domain(),r=D.select(".attribs").selectAll(".levelOverlay").data(v),a=r.enter().append("g");a.attr("class","levelOverlay").attr("id",function(t,e){return"level"+e}),e?a.merge(r).each(L):a.each(L);var i,c=a.merge(r).selectAll(".attribOverlay").data(function(t,e){return n.map(function(t){return{attrib:t,level:e}})}),d=c.enter().append("g").attr("class","attribOverlay").style("cursor","pointer");d.merge(c).attr("transform",function(t){return"translate("+l(t.attrib,t.level)+","+x[t.level].range()[0]+")"}),d.append("rect").merge(c.select("rect")).attr("fill","none").attr("x",0).attr("y",0).attr("width",function(){return 1.1*o.bandwidth()}).attr("height",function(t){return x[t.level].range()[1]-x[t.level].range()[0]}),d.append("text").merge(c.select("text")).style("cursor","point").style("-webkit-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").text(function(t){return"__seqId"===t.attrib?"sequential Index":t.attrib+(void 0!==m[t.level]&&m[t.level].attrib===t.attrib?m[t.level].reverse?" ↓":" ↑":"")}).attr("x",o.bandwidth()/2).attr("y",0).style("font-weight",function(t){return void 0!==m[t.level]&&m[t.level].attrib===t.attrib?"bolder":"normal"}).style("font-family","sans-serif").style("font-size",u.attribFontSize+"px").on("click",(i=F,function(t,e,n){B(this),setTimeout(()=>{i(t,e,n),N(this)},100)})).call(t.drag().container(d.merge(c).node()).on("start",j).on("drag",Q).on("end",Y)).on("mousemove",function(){var e=t.select(this);(e=void 0!==e.transition?e.transition().duration(150):e).style("font-size",u.attribFontSizeSelected+"px")}).on("mouseout",function(){var e=t.select(this);(e=void 0!==e.transition?e.transition().duration(150):e).style("font-size",u.attribFontSize+"px")}).attr("transform","rotate(-45)"),a.append("text").merge(r.select("text.numNodesLabel")).attr("class","numNodesLabel").style("font-family","sans-serif").style("pointer-events","none").merge(r.select(".numNodesLabel")).attr("y",function(t,e){return x[e].range()[1]+15}).attr("x",function(t,e){return s(e)}).text(function(t){return C(t.length)}),c.exit().remove(),r.exit().remove()}function j(e){t.event.sourceEvent.shiftKey&&t.select(this.parentNode).attr("transform",function(e){return"translate("+(t.event.x+u.attribFontSize/2)+","+x[e.level].range()[0]+")"})}function Q(e){t.event.sourceEvent.shiftKey&&t.select(this.parentNode).attr("transform",function(e){return"translate("+(t.event.x+u.attribFontSize/2)+","+x[e.level].range()[0]+")"})}function Y(e){if(t.event.sourceEvent.shiftKey){var n,r=M(o,t.event.x+u.attribFontSize/2-s(e.level));t.select(this.parentNode).attr("transform",function(t){return"translate("+l(t.attrib,t.level)+","+x[t.level].range()[0]+")"}),r!==e.attrib&&(n=g.indexOf(r),U(e.attrib,n),u.updateData(v))}}function H(t,e,n,r){d.beginPath(),t.forEach(function(t,e){0===e?d.moveTo(t.x,t.y):d.lineTo(t.x,t.y)}),d.lineWidth=e,r?(d.fillStyle=n,d.closePath(),d.fill()):(d.strokeStyle=n,d.stroke())}function J(t){if(!m.hasOwnProperty(t))return;performance.now();const e=m[t];v[t]=v[t].sort(function(t,n){return e.reverse?function(t,e){return null===t?null===e?0:-1:e<t?-1:e>t?1:e>=t?0:NaN}(f[t][e.attrib],f[n][e.attrib]):function(t,e){return null===e?null===t?0:-1:t<e?-1:t>e?1:t>=e?0:NaN}(f[t][e.attrib],f[n][e.attrib])}),v[t].forEach(function(e,n){f[e].__i[t]=n}),performance.now()}function U(t,e){var n=g.indexOf(t);-1!==n?e>g.length||e<0?console.err("moveAttrToPos pos out of bounds",e,g.length):(g.splice(n,1),g.splice(e,0,t)):console.err("moveAttrToPos attr not found",t)}return c.height=_*O,(d=c.getContext("2d")).scale(O,O),d.imageSmoothingEnabled=d.mozImageSmoothingEnabled=d.webkitImageSmoothingEnabled=!1,d.globalCompositeOperation="source-over",u.initData=function(e,n){performance.now(),(w=n).keys().forEach(function(t){p.set(t,!0)}),h=t.map();for(var r=0;r<f.length;r++){var a=f[r];a.__seqId=r,h.set(a[I],a),a.__i={},a.__i[0]=r}(y=[])[0]=[],performance.now()},u.updateData=function(e,n,r){var a;performance.now(),typeof e==typeof[]?(w=void 0!==n?n:w,v=e,y.splice(e.length),y[e.length]=[],b.splice(e.length),J(e.length-1),function(e){performance.now();var n=v.length-1;x.splice(n+1,x.length),x[e=void 0!==e?e:n]=t.scaleBand().range([q,_-u.margin-30]).paddingInner(0).paddingOuter(0);var r=[];if(v[e].length>_){var a=Math.max(Math.floor(v[e].length/(2*_)),1);v[e].itemsPerpixel=a;for(var i=0;i<v[e].length;i+=a)r.push(v[e][i])}else v[e].itemsPerpixel=1,r=v[e];v[e].representatives=r,x[e].domain(r.map(function(t){return f[t][I]})),p.keys().forEach(function(e){if("visible"!==e){var n=w.get(e);if("seq"===n.__type||"date"===n.__type)n.domain(t.extent(v[0].map(function(t){return f[t][e]})));else if("div"===n.__type){const[r,a]=t.extent(v[0].map(function(t){return f[t][e]})),i=Math.max(-r,a);n.domain([-i,i])}w.set(e,n)}}),o.domain(g).range([0,u.attribWidth*p.keys().length]).paddingInner(.1).paddingOuter(0),s.domain(v.map(function(t,e){return e})).range([E+u.margin,(o.range()[1]+u.levelsSeparation)*v.length+E]).paddingInner(0).paddingOuter(0),performance.now()}(r),a=s.range()[1]+u.margin+E,t.select(c).attr("width",a).attr("height",_).style("width",a).style("height",_+"px"),c.style.width=a+"px",c.style.height=_+"px",D.attr("width",a).attr("height",_),u.update(),performance.now()):console.error("navio updateData didn't receive an array")},u.update=function(t){var e,n=void 0!==t&&t,r=(performance.now(),s.range()[1]+u.margin+E);d.clearRect(0,0,r+1,_+1),v.forEach(function(t,e){var n;!function(t){d.beginPath(),d.rect(s(t),x[t].range()[0]-1,o.range()[1]+1,x[t].range()[1]+2-100),d.strokeStyle="black",d.lineWidth=1,d.stroke()}(e),t.representatives.forEach(function(t){!function(t,e){var n,r,a;for(x[e].bandwidth(),u.divisionsThreshold,r=0;r<g.length;r++)if(n=g[r],a=Math.round(x[e](t[I])+x[e].bandwidth()/2),d.beginPath(),d.moveTo(Math.round(l(n,e)),a),d.lineTo(Math.round(l(n,e)+o.bandwidth()),a),d.lineWidth=Math.ceil(x[e].bandwidth())+1,d.strokeStyle=void 0===t[n]||null===t[n]||""===t[n]||"none"===t[n]?"white":w.get(n)(t[n]),d.stroke(),x[e].bandwidth()>2*u.divisionsThreshold){var i=Math.round(x[e](t[I]));d.beginPath(),d.moveTo(l(n,e),i),d.lineTo(l(n,e)+o.bandwidth(),i),d.lineWidth=1,d.strokeStyle=u.divisionsColor,d.stroke()}}(f[t],e)}),(n=e)<=0||v[n].representatives.forEach(function(t){var e=h.get(f[t][I]).__i[n-1],r=Math.floor(e-e%v[n-1].itemsPerpixel),a={x:s(n-1)+o.range()[1],y:x[n-1](f[v[n-1][r]][I])},i={x:s(n),y:x[n](f[t][I])},l=[a,{x:a.x+.3*u.levelsSeparation,y:a.y},{x:i.x-.3*u.levelsSeparation,y:i.y},i,{x:i.x,y:i.y+x[n].bandwidth()},{x:i.x-.3*u.levelsSeparation,y:i.y+x[n].bandwidth()},{x:a.x+.3*u.levelsSeparation,y:a.y+x[n-1].bandwidth()},{x:a.x,y:a.y+x[n-1].bandwidth()},a];H(l,1,u.levelConvectionsColor),H(l,1,u.levelConvectionsColor,!0)})}),R(n),e=v.length-1,D.select("#closeButton").style("display",1===v.length?"none":"block").attr("transform","translate("+(s(e)+s.bandwidth()-u.levelsSeparation+15)+","+x[e].range()[0]+")"),performance.now()},u.addAttrib=function(t,e){if(-1===g.indexOf(t))return g.push(t),w.set(t,e),u},u.addSequentialAttrib=function(e,n){const r=void 0!==f&&f.length>0?t.extent(f,function(t){return t[e]}):[0,1],a=n||t.scaleSequential(S).domain(r);return a.__type="seq",u.addAttrib(e,a),u},u.addDateAttrib=function(e,n){const r=void 0!==f&&f.length>0?t.extent(f,function(t){return t[e]}):[0,1],a=n||t.scaleSequential(A).domain(r);return u.addAttrib(e,a),a.__type="date",u},u.addDivergingAttrib=function(e,n){const r=void 0!==f&&f.length>0?t.extent(f,function(t){return t[e]}):[-1,1],a=n||t.scaleSequential(k).domain([r[0],r[1]]);return a.__type="div",u.addAttrib(e,a),u},u.addCategoricalAttrib=function(e,n){const r=n||t.scaleOrdinal(t.schemeCategory10);return r.__type="cat",u.addAttrib(e,r),u},u.addAllAttribs=function(e){if(!f||!f.length)throw Error("addAllAttribs called without data to guess the attribs. Make sure to call it after setting the data");return(void 0!==e?e:function(t){var e,n=[];for(e in t)t.hasOwnProperty(e)&&n.push(e);return n}(f[0])).forEach(function(e){if("__seqId"===e||"__i"===e)return;const n=function(t,e){let n;for(n=0;n<u.howManyItemsShouldSearchForNotNull&&n<t.length;n++)if(null!==t[0][e]&&void 0!==t[0][e]&&""!==t[0][e])return t[n][e];return t[n][e]}(f,e);null==n||""===n?u.addCategoricalAttrib(e):"number"==typeof n?t.min(f,t=>t[e])<0?u.addDivergingAttrib(e):u.addSequentialAttrib(e):typeof n==typeof new Date?u.addDateAttrib(e):u.addCategoricalAttrib(e)}),u.data(f),R(!0),u},u.data=function(e){return w.has("visible")||(u.addAttrib("visible",t.scaleOrdinal().domain([!1,!0]).range(T)),U("visible",0)),w.has("__seqId")||(u.addSequentialAttrib("__seqId"),U("__seqId",1)),arguments.length?(e.forEach(function(t){t.visible=!0}),v=[(f=e).map(function(t,e){return e})],u.initData(v,w),u.updateData(v,w),u):f[0]},u.getVisible=function(){return v[v.length-1].filter(function(t){return f[t].visible}).map(function(t){return f[t]})},u.updateCallback=function(t){return arguments.length?(P=t,u):P},u.visibleColorRange=function(t){return arguments.length?(T=t,u):T},u.defaultColorInterpolator=function(t){return arguments.length?(S=t,u):S},u.id=function(t){return arguments.length?(I=t,u):I},u}});
