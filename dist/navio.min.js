// https://github.com/john-guerra/Navio#readme v0.0.15 Copyright 2019 John Alexis Guerra GÃ³mez
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("d3-scale-chromatic")):"function"==typeof define&&define.amd?define(["d3","d3-scale-chromatic"],t):e.navio=t(e.d3,e.d3ScaleChromatic)}(this,function(e,t){"use strict";class n{constructor(e){this.first=e.first,this.last=e.last,this.level=e.level}filter(e){return e.__i[this.level]>=this.first.__i[this.level]&&e.__i[this.level]<=this.last.__i[this.level]}}class r{constructor(e){this.itemAttr=e.itemAttr,this.sel=e.sel}filter(e){return e[this.itemAttr]===this.sel[this.itemAttr]}}return function(a,i){var o,l,s,c,d,u=this||{},f=[],v=[],h=e.map(),p=e.map(),g=[],m=e.map(),b=e.map(),y=[],x=[],w=void 0!==i?i:600,_=e.map(),S="interpolateBlues"in e?e.interpolateBlues:t.interpolateBlues,k=["white","#b5cf6b"],T=e.format(",.0d"),A=0,C=100,E="__seqId",z=function(){};function I(){e.event.preventDefault()}u.margin=10,u.attribWidth=15,u.levelsSeparation=40,u.divisionsColor="white",u.levelConvectionsColor="rgba(205, 220, 163, 0.5)",u.divisionsThreshold=4,u.attribFontSize=13,u.attribFontSizeSelected=32,u.startColor="white",u.endColor="red",u.legendFont="14px Arial",u.linkColor="#2171b5",(a=void 0===(a="string"==typeof a?e.select(a):a).selectAll?e.select(a):a).selectAll("*").remove(),a.on("touchstart",I).on("touchmove",I).style("height",w+"px").attr("class","navio").append("div").attr("id","navio").style("position","relative"),a.select("#navio").append("canvas");var O=a.select("#navio").append("svg").style("overflow","visible").style("position","absolute").style("z-index",99).style("top",0).style("left",0);O.append("g").attr("class","attribs"),O.append("g").attr("class","nvTooltip").style("text-shadow","0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff").attr("transform","translate(-100,-10)").append("text").attr("x",0).attr("y",0).style("pointer-events","none").style("font-family","sans-serif").style("font-size","16pt").style("text-anchor","middle"),O.select(".nvTooltip > text").append("tspan").attr("class","tool_id").attr("x",0).attr("dy","1.2em"),O.select(".nvTooltip > text").append("tspan").attr("class","tool_value_name").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),O.select(".nvTooltip > text").append("tspan").attr("class","tool_value_val").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),O.append("g").attr("id","closeButton").style("fill","white").style("stroke","black").style("display","none").append("path").call(function(t){var n=e.path();n.moveTo(0,0),n.lineTo(7,7),n.moveTo(7,0),n.lineTo(0,7),n.moveTo(11.9,3.5),n.arc(3.5,3.5,8.4,0,2*Math.PI),t.attr("d",n.toString())}).on("click",function(){v.length<=1||(F(v.length-2),v[v.length-2].forEach(function(e){f[e].visible=!0}),v=v.slice(0,v.length-1),u.updateData(v,_),z(u.getVisible()))}),o=e.scaleBand().range([0,u.attribWidth]).round(!0).paddingInner(.1).paddingOuter(0),s=e.scaleBand().round(!0),_=e.map(),l=function(e,t){return s(t)+o(e)},(c=a.select("canvas").node()).style.top=c.offsetTop+"px",c.style.left=c.offsetLeft+"px",c.style.height=w+"px";const P=window.devicePixelRatio;function q(t,n){var r=t.domain(),a=t.range();return e.scaleQuantize().domain(a).range(r)(n)}function D(t){e.event&&e.event.defaultPrevented||(performance.now(),v[t.level]=v[t.level].sort(function(n,r){return e.ascending(f[n][t.attrib],f[r][t.attrib])}),v[t.level].forEach(function(e,n){f[e].__i[t.level]=n}),performance.now(),m.set(t.level,t.attrib),u.updateData(v,_,t.level))}function F(t){e.select("#level"+t).selectAll(".brush").call(b.get(t).move,null)}function M(e){for(var t=0;t<v.length;t+=1)t!==e&&F(t)}function B(t,a){b.set(a,e.brushY().extent([[l(o.domain()[0],a),x[a].range()[0]],[l(o.domain()[o.domain().length-1],a)+1.1*o.bandwidth(),x[a].range()[1]]]).on("end",function(){if(!e.event.sourceEvent)return;if(!e.event.selection)return;M(a),performance.now();var t=e.event.selection,r=h.get(q(x[a],t[0])),i=h.get(q(x[a],t[1]));const o=new n({first:r,last:i,level:a});e.event.sourceEvent.shiftKey?y[a].push(o):y[a]=[o];var l=d();c(l),performance.now();var s=v;0!==l.length&&((s=v.slice(0,a+1)).push(l),u.updateData(s,_),z(u.getVisible()))}));var i=e.select(this).selectAll(".brush").data([{data:f[t],level:a}]);function c(e){for(var t=0;t<e.length;t++)f[e[t]].__i[a+1]=t}function d(){let e,t;e=performance.now();var n=v[a].filter(e=>{f[e].visible=!1;for(let t of y[a])if(t.filter(f[e])){f[e].visible=!0;break}return f[e].visible});return t=performance.now(),n}i.enter().merge(i).append("g").on("mousemove",W).on("click",function(){var t=e.mouse(e.event.target)[1];!function(t,n){M(-1),performance.now();var i=q(x[a],n),l=(performance.now(),q(o,t-s(a)));if(void 0===l)return;var f=h.get(i);const p=new r({sel:f,itemAttr:l});e.event.shiftKey?y[a].push(p):y[a]=[p];var g=d();c(g);var m=v.slice(0,a+1);m.push(g),u.updateData(m,_),z(u.getVisible())}(e.mouse(e.event.target)[0],t)}).on("mouseout",K).attr("class","brush").call(b.get(a)).selectAll("rect").attr("width",l(o.domain()[o.domain().length-1],a)+1.1*o.bandwidth()),i.exit().remove()}function W(t){var n=e.mouse(e.event.target)[1],r=e.mouse(e.event.target)[0],a=q(x[t.level],n),i=q(o,r-s(t.level)),l=h.get(a);O.select(".nvTooltip").attr("transform","translate("+r+","+(n+20)+")").call(function(e){e.select(".tool_id").text(a),e.select(".tool_value_name").text(i+" : "),e.select(".tool_value_val").text(l[i])})}function K(){O.select(".nvTooltip").attr("transform","translate(-200,-200)").call(function(e){e.select(".tool_id").text(""),e.select(".tool_value_name").text(""),e.select(".tool_value_val").text("")})}function N(t){e.event.sourceEvent.shiftKey&&e.select(this.parentNode).attr("transform",function(t){return"translate("+(e.event.x+u.attribFontSize/2)+","+x[t.level].range()[0]+")"})}function V(t){e.event.sourceEvent.shiftKey&&e.select(this.parentNode).attr("transform",function(t){return"translate("+(e.event.x+u.attribFontSize/2)+","+x[t.level].range()[0]+")"})}function L(t){if(e.event.sourceEvent.shiftKey){var n,r=q(o,e.event.x+u.attribFontSize/2-s(t.level));e.select(this.parentNode).attr("transform",function(e){return"translate("+l(e.attrib,e.level)+","+x[e.level].range()[0]+")"}),r!==t.attrib&&(n=g.indexOf(r),j(t.attrib,n),u.updateData(v))}}function R(e,t,n,r){d.beginPath(),e.forEach(function(e,t){0===t?d.moveTo(e.x,e.y):d.lineTo(e.x,e.y)}),d.lineWidth=t,r?(d.fillStyle=n,d.closePath(),d.fill()):(d.strokeStyle=n,d.stroke())}function j(e,t){var n=g.indexOf(e);-1!==n?t>g.length||t<0?console.err("moveAttrToPos pos out of bounds",t,g.length):(g.splice(n,1),g.splice(t,0,e)):console.err("moveAttrToPos attr not found",e)}return c.height=w*P,(d=c.getContext("2d")).scale(P,P),d.imageSmoothingEnabled=d.mozImageSmoothingEnabled=d.webkitImageSmoothingEnabled=!1,d.globalCompositeOperation="source-over",u.initData=function(t,n){performance.now(),(_=n).keys().forEach(function(e){p.set(e,!0)}),h=e.map();for(var r=0;r<f.length;r++){var a=f[r];a.__seqId=r,h.set(a[E],a),a.__i={},a.__i[0]=r}(y=[])[0]=[],performance.now()},u.updateData=function(t,n,r){var a;performance.now(),typeof t==typeof[]?(_=void 0!==n?n:_,v=t,y.splice(v.length),y[v.length]=[],function(t){performance.now();var n=v.length-1;x.splice(n+1,x.length),x[t=void 0!==t?t:n]=e.scaleBand().range([C,w-u.margin-30]).paddingInner(0).paddingOuter(0);var r=[];if(v[t].length>w){var a=Math.max(Math.floor(v[t].length/(2*w)),1);v[t].itemsPerpixel=a;for(var i=0;i<v[t].length;i+=a)r.push(v[t][i])}else v[t].itemsPerpixel=1,r=v[t];v[t].representatives=r,x[t].domain(r.map(function(e){return f[e][E]})),p.keys().forEach(function(t){if("visible"!==t){var n=_.get(t);n.domain(e.extent(v[0].representatives.map(function(e){return f[e][t]}))),_.set(t,n)}}),o.domain(g).range([0,u.attribWidth*p.keys().length]).paddingInner(.1).paddingOuter(0),s.domain(v.map(function(e,t){return t})).range([A+u.margin,(o.range()[1]+u.levelsSeparation)*v.length+A]).paddingInner(0).paddingOuter(0),performance.now()}(r),a=s.range()[1]+u.margin+A,e.select(c).attr("width",a).attr("height",w).style("width",a).style("height",w+"px"),c.style.width=a+"px",c.style.height=w+"px",O.attr("width",a).attr("height",w),u.update(),performance.now()):console.error("navio updateData didn't receive an array")},u.update=function(){performance.now();var t,n,r,a,i,c,p=s.range()[1]+u.margin+A;d.clearRect(0,0,p+1,w+1),v.forEach(function(e,t){var n;!function(e){d.beginPath(),d.rect(s(e),x[e].range()[0]-1,o.range()[1]+1,x[e].range()[1]+2-100),d.strokeStyle="black",d.lineWidth=1,d.stroke()}(t),e.representatives.forEach(function(e){!function(e,t){var n,r,a;for(x[t].bandwidth(),u.divisionsThreshold,r=0;r<g.length;r++)if(n=g[r],a=Math.round(x[t](e[E])+x[t].bandwidth()/2),d.beginPath(),d.moveTo(Math.round(l(n,t)),a),d.lineTo(Math.round(l(n,t)+o.bandwidth()),a),d.lineWidth=Math.ceil(x[t].bandwidth())+1,d.strokeStyle=void 0===e[n]||null===e[n]||""===e[n]||"none"===e[n]?"white":_.get(n)(e[n]),d.stroke(),x[t].bandwidth()>2*u.divisionsThreshold){var i=Math.round(x[t](e[E]));d.beginPath(),d.moveTo(l(n,t),i),d.lineTo(l(n,t)+o.bandwidth(),i),d.lineWidth=1,d.strokeStyle=u.divisionsColor,d.stroke()}}(f[e],t)}),(n=t)<=0||v[n].representatives.forEach(function(e){var t=h.get(f[e][E]).__i[n-1],r=Math.floor(t-t%v[n-1].itemsPerpixel),a={x:s(n-1)+o.range()[1],y:x[n-1](f[v[n-1][r]][E])},i={x:s(n),y:x[n](f[e][E])},l=[a,{x:a.x+.3*u.levelsSeparation,y:a.y},{x:i.x-.3*u.levelsSeparation,y:i.y},i,{x:i.x,y:i.y+x[n].bandwidth()},{x:i.x-.3*u.levelsSeparation,y:i.y+x[n].bandwidth()},{x:a.x+.3*u.levelsSeparation,y:a.y+x[n-1].bandwidth()},{x:a.x,y:a.y+x[n-1].bandwidth()},a];R(l,1,u.levelConvectionsColor),R(l,1,u.levelConvectionsColor,!0)})}),t=o.domain(),n=O.select(".attribs").selectAll(".levelOverlay").data(v),r=n.enter().append("g").attr("class","levelOverlay").attr("id",function(e,t){return"level"+t}).each(B),a=r.merge(n).selectAll(".attribOverlay").data(function(e,n){return t.map(function(e){return{attrib:e,level:n}})}),(i=a.enter().append("g").attr("class","attribOverlay").style("cursor","pointer")).merge(a).attr("transform",function(e){return"translate("+l(e.attrib,e.level)+","+x[e.level].range()[0]+")"}),i.append("rect").merge(a.select("rect")).attr("fill","none").attr("x",0).attr("y",0).attr("width",function(){return 1.1*o.bandwidth()}).attr("height",function(e){return x[e.level].range()[1]-x[e.level].range()[0]}),i.append("text").merge(a.select("text")).style("cursor","point").style("-webkit-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").text(function(e){return"__seqId"===e.attrib?"sequential Index":e.attrib}).attr("x",o.bandwidth()/2).attr("y",0).style("font-weight",function(e){return m.has(e.level)&&m.get(e.level)===e.attrib?"bolder":"normal"}).style("font-family","sans-serif").style("font-size",u.attribFontSize+"px").on("click",D).call(e.drag().container(i.merge(a).node()).on("start",N).on("drag",V).on("end",L)).on("mousemove",function(){var t=e.select(this);(t=void 0!==t.transition?t.transition().duration(150):t).style("font-size",u.attribFontSizeSelected+"px")}).on("mouseout",function(){var t=e.select(this);(t=void 0!==t.transition?t.transition().duration(150):t).style("font-size",u.attribFontSize+"px")}).attr("transform","rotate(-45)"),r.append("text").attr("class","numNodesLabel").style("font-family","sans-serif").style("pointer-events","none").merge(n.select(".numNodesLabel")).attr("y",function(e,t){return x[t].range()[1]+15}).attr("x",function(e,t){return s(t)}).text(function(e){return T(e.length)}),a.exit().remove(),n.exit().remove(),c=v.length-1,O.select("#closeButton").style("display",1===v.length?"none":"block").attr("transform","translate("+(s(c)+s.bandwidth()-u.levelsSeparation+15)+","+x[c].range()[0]+")"),performance.now()},u.addAttrib=function(e,t){if(-1===g.indexOf(e))return g.push(e),_.set(e,t),u},u.addSequentialAttrib=function(t,n){return u.addAttrib(t,n||e.scaleSequential(S).domain(void 0!==f&&f.length>0?e.extent(f,function(e){return e[t]}):[0,1])),u},u.addCategoricalAttrib=function(t,n){return u.addAttrib(t,n||e.scaleOrdinal(e.schemeCategory10)),u},u.data=function(t){return _.has("visible")||(u.addAttrib("visible",e.scaleOrdinal().domain([!1,!0]).range(k)),j("visible",0)),_.has("__seqId")||(u.addSequentialAttrib("__seqId"),j("__seqId",1)),arguments.length?(t.forEach(function(e){e.visible=!0}),v=[(f=t).map(function(e,t){return t})],u.initData(v,_),u.updateData(v,_),u):f[0]},u.getVisible=function(){return v[v.length-1].filter(function(e){return f[e].visible}).map(function(e){return f[e]})},u.updateCallback=function(e){return arguments.length?(z=e,u):z},u.visibleColorRange=function(e){return arguments.length?(k=e,u):k},u.defaultColorInterpolator=function(e){return arguments.length?(S=e,u):S},u.id=function(e){return arguments.length?(E=e,u):E},u}});
