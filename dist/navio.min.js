// https://github.com/john-guerra/Navio#readme v0.0.14 Copyright 2019 John Alexis Guerra GÃ³mez
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("d3-scale-chromatic")):"function"==typeof define&&define.amd?define(["d3","d3-scale-chromatic"],t):e.navio=t(e.d3,e.d3ScaleChromatic)}(this,function(e,t){"use strict";class n{constructor(e){this.first=e.first,this.last=e.last,this.level=e.level}filter(e){return e.__i[this.level]>=this.first.__i[this.level]&&e.__i[this.level]<=this.last.__i[this.level]}}class o{constructor(e){this.itemAttr=e.itemAttr,this.sel=e.sel}filter(e){return e[this.itemAttr]===this.sel[this.itemAttr]}}return function(a,l){var r,i,s,c,d,u=this||{},f=[],v=[],p=e.map(),g=e.map(),h=[],m=e.map(),b=e.map(),y=[],x=[],w=void 0!==l?l:600,_=e.map(),S="interpolateBlues"in e?e.interpolateBlues:t.interpolateBlues,k=["white","#b5cf6b"],C=e.format(",.0d"),A=0,T=100,E="__seqId",z=function(){};function I(){console.log("nozoom"),e.event.preventDefault()}u.margin=10,u.attribWidth=15,u.levelsSeparation=40,u.divisionsColor="white",u.levelConvectionsColor="rgba(205, 220, 163, 0.5)",u.divisionsThreshold=4,u.attribFontSize=13,u.attribFontSizeSelected=32,u.startColor="white",u.endColor="red",u.legendFont="14px Arial",u.linkColor="#2171b5",(a=void 0===(a="string"==typeof a?e.select(a):a).selectAll?e.select(a):a).selectAll("*").remove(),a.on("touchstart",I).on("touchmove",I).style("height",w+"px").attr("class","navio").append("div").attr("id","navio").style("position","relative"),a.select("#navio").append("canvas");var D=a.select("#navio").append("svg").style("overflow","visible").style("position","absolute").style("z-index",99).style("top",0).style("left",0);D.append("g").attr("class","attribs"),D.append("g").attr("class","nvTooltip").style("text-shadow","0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff").attr("transform","translate(-100,-10)").append("text").attr("x",0).attr("y",0).style("pointer-events","none").style("font-family","sans-serif").style("font-size","16pt").style("text-anchor","middle"),D.select(".nvTooltip > text").append("tspan").attr("class","tool_id").attr("x",0).attr("dy","1.2em"),D.select(".nvTooltip > text").append("tspan").attr("class","tool_value_name").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),D.select(".nvTooltip > text").append("tspan").attr("class","tool_value_val").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),D.append("g").attr("id","closeButton").style("fill","white").style("stroke","black").style("display","none").append("path").call(function(t){var n=e.path();n.moveTo(0,0),n.lineTo(7,7),n.moveTo(7,0),n.lineTo(0,7),n.moveTo(11.9,3.5),n.arc(3.5,3.5,8.4,0,2*Math.PI),t.attr("d",n.toString())}).on("click",function(){v.length<=1||(console.log("Delete one level"),F(v.length-2),v[v.length-2].forEach(function(e){f[e].visible=!0}),v=v.slice(0,v.length-1),u.updateData(v,_),z(u.getVisible()))}),r=e.scaleBand().range([0,u.attribWidth]).round(!0).paddingInner(.1).paddingOuter(0),s=e.scaleBand().round(!0),_=e.map(),i=function(e,t){return s(t)+r(e)},(c=a.select("canvas").node()).style.top=c.offsetTop+"px",c.style.left=c.offsetLeft+"px",c.style.height=w+"px";const O=window.devicePixelRatio;function P(t,n){var o=t.domain(),a=t.range();return e.scaleQuantize().domain(a).range(o)(n)}function q(t){if(!e.event||!e.event.defaultPrevented){console.log("click "+t);var n=performance.now();v[t.level]=v[t.level].sort(function(n,o){return e.ascending(f[n][t.attrib],f[o][t.attrib])}),v[t.level].forEach(function(e,n){f[e].__i[t.level]=n});var o=performance.now();console.log("Click sorting "+(o-n)+"ms"),m.set(t.level,t.attrib),u.updateData(v,_,t.level)}}function F(t){e.select("#level"+t).selectAll(".brush").call(b.get(t).move,null)}function B(e){for(var t=0;t<v.length;t+=1)t!==e&&F(t)}function M(t,a){b.set(a,e.brushY().extent([[i(r.domain()[0],a),x[a].range()[0]],[i(r.domain()[r.domain().length-1],a)+1.1*r.bandwidth(),x[a].range()[1]]]).on("end",function(){if(!e.event.sourceEvent)return;if(!e.event.selection)return void console.log("Empty selection",e.event.selection,e.event.type,e.event.sourceEvent);B(a);var t=performance.now(),o=e.event.selection,l=p.get(P(x[a],o[0])),r=p.get(P(x[a],o[1]));const i=new n({first:l,last:r,level:a});e.event.sourceEvent.shiftKey?y[a].push(i):y[a]=[i];var s=d();c(s);var f=performance.now();console.log("Brushend filtering "+(f-t)+"ms"),console.log("Computing new data");var g=v;0!==s.length?((g=v.slice(0,a+1)).push(s),u.updateData(g,_),console.log("out of updateData"),console.log("Selected "+s.length+" calling updateCallback"),z(u.getVisible())):console.log("Empty selection!")}));var l=e.select(this).selectAll(".brush").data([{data:f[t],level:a}]);function c(e){for(var t=0;t<e.length;t++)f[e[t]].__i[a+1]=t}function d(){let e,t;console.log("applyFilters ",y),e=performance.now();var n=v[a].filter(e=>{f[e].visible=!1;for(let t of y[a])if(t.filter(f[e])){f[e].visible=!0;break}return f[e].visible});return t=performance.now(),console.log("Applying filters "+(t-e)+"ms"),n}l.enter().merge(l).append("g").on("mousemove",W).on("click",function(){console.log("click");var t=e.mouse(e.event.target)[1];!function(t,n){console.log("onSelectByValueFromCoords",t,n),B(-1);var l=performance.now(),i=P(x[a],n),f=performance.now();console.log("invertOrdinalScale "+(f-l)+"ms");var g=P(r,t-s(a));if(void 0===g)return;var h=p.get(i);const m=new o({sel:h,itemAttr:g});e.event.shiftKey?y[a].push(m):y[a]=[m];var b=d();c(b);var w=v.slice(0,a+1);w.push(b),u.updateData(w,_),console.log("Selected "+u.getVisible().length+" calling updateCallback"),z(u.getVisible())}(e.mouse(e.event.target)[0],t)}).on("mouseout",V).attr("class","brush").call(b.get(a)).selectAll("rect").attr("width",i(r.domain()[r.domain().length-1],a)+1.1*r.bandwidth()),l.exit().remove()}function W(t){var n=e.mouse(e.event.target)[1],o=e.mouse(e.event.target)[0],a=P(x[t.level],n),l=P(r,o-s(t.level)),i=p.get(a);D.select(".nvTooltip").attr("transform","translate("+o+","+(n+20)+")").call(function(e){e.select(".tool_id").text(a),e.select(".tool_value_name").text(l+" : "),e.select(".tool_value_val").text(i[l])})}function V(){D.select(".nvTooltip").attr("transform","translate(-200,-200)").call(function(e){e.select(".tool_id").text(""),e.select(".tool_value_name").text(""),e.select(".tool_value_val").text("")})}function K(t){e.event.sourceEvent.shiftKey&&(console.log("start",t),e.select(this.parentNode).attr("transform",function(t){return"translate("+(e.event.x+u.attribFontSize/2)+","+x[t.level].range()[0]+")"}))}function N(t){e.event.sourceEvent.shiftKey&&e.select(this.parentNode).attr("transform",function(t){return"translate("+(e.event.x+u.attribFontSize/2)+","+x[t.level].range()[0]+")"})}function R(t){if(e.event.sourceEvent.shiftKey){console.log("end",t);var n,o=P(r,e.event.x+u.attribFontSize/2-s(t.level));e.select(this.parentNode).attr("transform",function(e){return"translate("+i(e.attrib,e.level)+","+x[e.level].range()[0]+")"}),o!==t.attrib&&(n=h.indexOf(o),L(t.attrib,n),u.updateData(v))}}function U(e,t,n,o){d.beginPath(),e.forEach(function(e,t){0===t?d.moveTo(e.x,e.y):d.lineTo(e.x,e.y)}),d.lineWidth=t,o?(d.fillStyle=n,d.closePath(),d.fill()):(d.strokeStyle=n,d.stroke())}function L(e,t){var n=h.indexOf(e);-1!==n?t>h.length||t<0?console.err("moveAttrToPos pos out of bounds",t,h.length):(h.splice(n,1),h.splice(t,0,e)):console.err("moveAttrToPos attr not found",e)}return c.height=w*O,(d=c.getContext("2d")).scale(O,O),d.imageSmoothingEnabled=d.mozImageSmoothingEnabled=d.webkitImageSmoothingEnabled=!1,d.globalCompositeOperation="source-over",u.initData=function(t,n){var o=performance.now();(_=n).keys().forEach(function(e){g.set(e,!0)}),p=e.map();for(var a=0;a<f.length;a++){var l=f[a];l.__seqId=a,p.set(l[E],l),l.__i={},l.__i[0]=a}(y=[])[0]=[];var r=performance.now();console.log("Init data "+(r-o)+"ms")},u.updateData=function(t,n,o){console.log("updateData");var a,l=performance.now();if(typeof t==typeof[]){_=void 0!==n?n:_,v=t,y.splice(v.length),y[v.length]=[],function(t){console.log("Update scales");var n=performance.now(),o=v.length-1;console.log("Delete unvecessary scales"),x.splice(o+1,x.length),x[t=void 0!==t?t:o]=e.scaleBand().range([T,w-u.margin-30]).paddingInner(0).paddingOuter(0),console.log("Compute representatives");var a=[];if(v[t].length>w){var l=Math.max(Math.floor(v[t].length/(2*w)),1);console.log("itemsPerpixel",l),v[t].itemsPerpixel=l;for(var i=0;i<v[t].length;i+=l)a.push(v[t][i])}else v[t].itemsPerpixel=1,a=v[t];v[t].representatives=a,x[t].domain(a.map(function(e){return f[e][E]})),console.log("Update color scale domains"),g.keys().forEach(function(t){if("visible"!==t){var n=_.get(t);n.domain(e.extent(v[0].representatives.map(function(e){return f[e][t]}))),_.set(t,n)}}),r.domain(h).range([0,u.attribWidth*g.keys().length]).paddingInner(.1).paddingOuter(0),s.domain(v.map(function(e,t){return t})).range([A+u.margin,(r.range()[1]+u.levelsSeparation)*v.length+A]).paddingInner(0).paddingOuter(0);var c=performance.now();console.log("Updating Scales "+(c-n)+"ms")}(o),a=s.range()[1]+u.margin+A,e.select(c).attr("width",a).attr("height",w).style("width",a).style("height",w+"px"),c.style.width=a+"px",c.style.height=w+"px",D.attr("width",a).attr("height",w),u.update();var i=performance.now();console.log("Updating data "+(i-l)+"ms")}else console.error("navio updateData didn't receive an array")},u.update=function(){var t,n,o,a,l,c,g=performance.now(),b=s.range()[1]+u.margin+A;d.clearRect(0,0,b+1,w+1),v.forEach(function(e,t){var n;!function(e){d.beginPath(),d.rect(s(e),x[e].range()[0]-1,r.range()[1]+1,x[e].range()[1]+2-100),d.strokeStyle="black",d.lineWidth=1,d.stroke()}(t),e.representatives.forEach(function(e){!function(e,t){var n,o,a;for(x[t].bandwidth()>u.divisionsThreshold&&console.log("Add borders"),o=0;o<h.length;o++)if(n=h[o],a=Math.round(x[t](e[E])+x[t].bandwidth()/2),d.beginPath(),d.moveTo(Math.round(i(n,t)),a),d.lineTo(Math.round(i(n,t)+r.bandwidth()),a),d.lineWidth=Math.ceil(x[t].bandwidth())+1,d.strokeStyle=void 0===e[n]||null===e[n]||""===e[n]||"none"===e[n]?"white":_.get(n)(e[n]),d.stroke(),x[t].bandwidth()>2*u.divisionsThreshold){var l=Math.round(x[t](e[E]));d.beginPath(),d.moveTo(i(n,t),l),d.lineTo(i(n,t)+r.bandwidth(),l),d.lineWidth=1,d.strokeStyle=u.divisionsColor,d.stroke()}}(f[e],t)}),(n=t)<=0||v[n].representatives.forEach(function(e){var t=p.get(f[e][E]).__i[n-1],o=Math.floor(t-t%v[n-1].itemsPerpixel),a={x:s(n-1)+r.range()[1],y:x[n-1](f[v[n-1][o]][E])},l={x:s(n),y:x[n](f[e][E])},i=[a,{x:a.x+.3*u.levelsSeparation,y:a.y},{x:l.x-.3*u.levelsSeparation,y:l.y},l,{x:l.x,y:l.y+x[n].bandwidth()},{x:l.x-.3*u.levelsSeparation,y:l.y+x[n].bandwidth()},{x:a.x+.3*u.levelsSeparation,y:a.y+x[n-1].bandwidth()},{x:a.x,y:a.y+x[n-1].bandwidth()},a];U(i,1,u.levelConvectionsColor),U(i,1,u.levelConvectionsColor,!0)})}),t=r.domain(),n=D.select(".attribs").selectAll(".levelOverlay").data(v),o=n.enter().append("g").attr("class","levelOverlay").attr("id",function(e,t){return"level"+t}).each(M),a=o.merge(n).selectAll(".attribOverlay").data(function(e,n){return t.map(function(e){return{attrib:e,level:n}})}),(l=a.enter().append("g").attr("class","attribOverlay").style("cursor","pointer")).merge(a).attr("transform",function(e){return"translate("+i(e.attrib,e.level)+","+x[e.level].range()[0]+")"}),l.append("rect").merge(a.select("rect")).attr("fill","none").attr("x",0).attr("y",0).attr("width",function(){return 1.1*r.bandwidth()}).attr("height",function(e){return x[e.level].range()[1]-x[e.level].range()[0]}),l.append("text").merge(a.select("text")).style("cursor","point").style("-webkit-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").text(function(e){return"__seqId"===e.attrib?"sequential Index":e.attrib}).attr("x",r.bandwidth()/2).attr("y",0).style("font-weight",function(e){return m.has(e.level)&&m.get(e.level)===e.attrib?"bolder":"normal"}).style("font-family","sans-serif").style("font-size",u.attribFontSize+"px").on("click",q).call(e.drag().container(l.merge(a).node()).on("start",K).on("drag",N).on("end",R)).on("mousemove",function(){var t=e.select(this);(t=void 0!==t.transition?t.transition().duration(150):t).style("font-size",u.attribFontSizeSelected+"px")}).on("mouseout",function(){var t=e.select(this);(t=void 0!==t.transition?t.transition().duration(150):t).style("font-size",u.attribFontSize+"px")}).attr("transform","rotate(-45)"),o.append("text").attr("class","numNodesLabel").style("font-family","sans-serif").style("pointer-events","none").merge(n.select(".numNodesLabel")).attr("y",function(e,t){return x[t].range()[1]+15}).attr("x",function(e,t){return s(t)}).text(function(e){return C(e.length)}),a.exit().remove(),n.exit().remove(),c=v.length-1,D.select("#closeButton").style("display",1===v.length?"none":"block").attr("transform","translate("+(s(c)+s.bandwidth()-u.levelsSeparation+15)+","+x[c].range()[0]+")");var y=performance.now();console.log("Redrawing "+(y-g)+"ms")},u.addAttrib=function(e,t){if(-1===h.indexOf(e))return h.push(e),_.set(e,t),u},u.addSequentialAttrib=function(t,n){return u.addAttrib(t,n||e.scaleSequential(S).domain(void 0!==f&&f.length>0?e.extent(f,function(e){return e[t]}):[0,1])),u},u.addCategoricalAttrib=function(t,n){return u.addAttrib(t,n||e.scaleOrdinal(e.schemeCategory10)),u},u.data=function(t){return _.has("visible")||(u.addAttrib("visible",e.scaleOrdinal().domain([!1,!0]).range(k)),L("visible",0)),_.has("__seqId")||(u.addSequentialAttrib("__seqId"),L("__seqId",1)),arguments.length?(t.forEach(function(e){e.visible=!0}),v=[(f=t).map(function(e,t){return t})],u.initData(v,_),u.updateData(v,_),u):f[0]},u.getVisible=function(){return v[v.length-1].filter(function(e){return f[e].visible}).map(function(e){return f[e]})},u.updateCallback=function(e){return arguments.length?(z=e,u):z},u.visibleColorRange=function(e){return arguments.length?(k=e,u):k},u.defaultColorInterpolator=function(e){return arguments.length?(S=e,u):S},u.id=function(e){return arguments.length?(E=e,u):E},u}});
