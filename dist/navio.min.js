// https://github.com/john-guerra/Navio#readme v0.0.23 Copyright 2019 John Alexis Guerra Gómez
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3"),require("d3-scale-chromatic")):"function"==typeof define&&define.amd?define(["d3","d3-scale-chromatic"],e):t.navio=e(t.d3,t.d3ScaleChromatic)}(this,function(t,e){"use strict";class n{constructor(t){this.first=t.first,this.last=t.last,this.level=t.level}filter(t){return t.__i[this.level]>=this.first.__i[this.level]&&t.__i[this.level]<=this.last.__i[this.level]}}class r{constructor(t){this.itemAttr=t.itemAttr,this.sel=t.sel}filter(t){return t[this.itemAttr]===this.sel[this.itemAttr]}}function i(n=1){const r="interpolateGreys"in t?t.interpolateGreys:e._interpolateGreys;let i=t.scaleSequential(r).domain([32,90]),a=t.map(),o=t.map();function l(t){let e=o.get(t.slice(0,n));return void 0===e&&(console.log(`scaleText Couldn't find index for ${t.slice(0,n)} did you call domain? Using ascii of first letter`),e=t.slice(0,n).charCodeAt(0)),i(e)||"white"}function s(e,n=!0){a=t.map();for(let t of e)a.has(t)||a.set(t,0),a.set(t,a.get(t)+1);const r={counts:a};if(n){o=t.map();let e=0;for(let t of a.keys().sort())o.set(t,e++);r.indexes=o}return r}return l.digits=function(t){return arguments.length?(n=t,l):n},l.scale=function(t){return arguments.length?(i=t,l):i},l.domain=function(t){return arguments.length?(s(t.filter(t=>null!=t).map(t=>t.slice(0,n))),i.domain([0,a.keys().length]),l):i.domain()},l.computeRepresentatives=s,l.__type="text",l}return function(a,o){var l,s,c,d,u,f=this||{},h=[],v=[],p=[],g=[],m=t.map(),b=t.map(),y=[],x=[],w=[],_=[],A=[],S=void 0!==o?o:600,k=t.map(),T="interpolateBlues"in t?t.interpolateBlues:e.interpolateBlues,C="interpolatePurples"in t?t.interpolatePurples:e.interpolatePurples,N="interpolateBrBG"in t?t.interpolateBrBG:e.interpolateBrBG,D=["white","#b5cf6b"],q=t.format(",.0d"),E=0,I=100,P="__seqId",M=function(){};function z(){t.event.preventDefault()}f.maxNumDistictForCategorical=10,f.howManyItemsShouldSearchForNotNull=100,f.margin=10,f.attribWidth=15,f.levelsSeparation=40,f.divisionsColor="white",f.levelConvectionsColor="rgba(205, 220, 163, 0.5)",f.divisionsThreshold=4,f.attribFontSize=13,f.attribFontSizeSelected=32,f.startColor="white",f.endColor="red",f.legendFont="14px Arial",f.linkColor="#2171b5",(a=void 0===(a="string"==typeof a?t.select(a):a).selectAll?t.select(a):a).selectAll("*").remove(),a.on("touchstart",z).on("touchmove",z).style("height",S+"px").attr("class","navio").append("div").attr("id","navio").style("position","relative"),a.select("#navio").append("canvas");var O=a.select("#navio").append("svg").style("overflow","visible").style("position","absolute").style("z-index",99).style("top",0).style("left",0);O.append("g").attr("class","attribs"),O.append("g").attr("class","nvTooltip").style("text-shadow","0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff").attr("transform","translate(-100,-10)").append("text").attr("x",0).attr("y",0).style("pointer-events","none").style("font-family","sans-serif").style("font-size","16pt").style("text-anchor","middle"),O.select(".nvTooltip > text").append("tspan").attr("class","tool_id").attr("x",0).attr("dy","1.2em"),O.select(".nvTooltip > text").append("tspan").attr("class","tool_value_name").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),O.select(".nvTooltip > text").append("tspan").attr("class","tool_value_val").style("font-weight","bold").attr("x",0).attr("dy","1.2em"),O.append("g").attr("id","closeButton").style("fill","white").style("stroke","black").style("display","none").append("path").call(function(e){var n=t.path();n.moveTo(0,0),n.lineTo(7,7),n.moveTo(7,0),n.lineTo(0,7),n.moveTo(11.9,3.5),n.arc(3.5,3.5,8.4,0,2*Math.PI),e.attr("d",n.toString())}).on("click",function(){v.length<=1||(F(this),R(v.length-2),v[v.length-2].forEach(function(t){h[t].visible=!0}),v=v.slice(0,v.length-1),f.updateData(v,k),M(f.getVisible()),$(this))}),l=t.scaleBand().range([0,f.attribWidth]).round(!0).paddingInner(.1).paddingOuter(0),c=t.scaleBand().round(!0),k=t.map(),s=function(t,e){return c(e)+l(t)},(d=a.select("canvas").node()).style.top=d.offsetTop+"px",d.style.left=d.offsetLeft+"px",d.style.height=S+"px";const B=window.devicePixelRatio;function F(e){t.select(e).style("cursor","progress"),O.style("cursor","progress")}function $(e){t.select(e).style("cursor",null),O.style("cursor",null)}function W(e,n){var r=e.domain(),i=e.range();return t.scaleQuantize().domain(i).range(r)(n)}function G(t){if(!x.hasOwnProperty(t))return;performance.now();const e=x[t];v[t].sort(function(t,n){return e.reverse?function(t,e){return null==e?null==t?0:-1:null==t?1:t<e?1:t>e?-1:t>=e?0:NaN}(h[t][e.attrib],h[n][e.attrib]):function(t,e){return null==e?null==t?0:1:null==t?-1:t<e?-1:t>e?1:t>=e?0:NaN}(h[t][e.attrib],h[n][e.attrib])}),V(v[t],t),performance.now()}function K(e){t.event&&t.event.defaultPrevented||(x[e.level]={attrib:e.attrib,reverse:void 0!==x[e.level]&&x[e.level].attrib===e.attrib&&!x[e.level].reverse},G(e.level),R(e.level),f.updateData(v,k,{levelToUpdate:e.level}),M(f.getVisible()))}function R(e){t.select("#level"+e).selectAll(".brush").call(w[e].move,null)}function U(t){for(var e=0;e<v.length;e+=1)e!==t&&R(e)}function V(t,e){for(var n=0;n<t.length;n++)h[t[n]].__i[e]=n}function L(e,i){w[i]=t.brushY().extent([[s(l.domain()[0],i),A[i].range()[0]],[s(l.domain()[l.domain().length-1],i)+1.1*l.bandwidth(),A[i].range()[1]]]).on("end",function(){if(F(this),!t.event.sourceEvent)return;if(!t.event.selection)return;U(i),performance.now();var e=t.event.selection,r=m.get(W(A[i],e[0])),a=m.get(W(A[i],e[1]));const l=new n({first:r,last:a,level:i});t.event.sourceEvent.shiftKey?_[i].push(l):_[i]=[l];var s=o();V(s,i+1),performance.now();var c=v;0!==s.length&&((c=v.slice(0,i+1)).push(s),f.updateData(c,k),M(f.getVisible()),$(this))});var a=t.select(this).selectAll(".brush").data([{data:h[e],level:i}]);function o(){let t,e;t=performance.now();var n=v[i].filter(t=>{h[t].visible=!1;for(let e of _[i])if(e.filter(h[t])){h[t].visible=!0;break}return h[t].visible});return e=performance.now(),n}a.enter().merge(a).append("g").on("mousemove",j).on("click",function(){F(this);var e=t.mouse(t.event.target)[1];(function(e,n){U(-1),performance.now();var a=W(A[i],n),s=(performance.now(),W(l,e-c(i)));if(void 0===s)return;var d=m.get(a);const u=new r({sel:d,itemAttr:s});t.event.shiftKey?_[i].push(u):_[i]=[u];var h=o();V(h,i+1);var p=v.slice(0,i+1);p.push(h),f.updateData(p,k),M(f.getVisible())})(t.mouse(t.event.target)[0],e),$(this)}).on("mouseout",Q).attr("class","brush").call(w[i]).selectAll("rect").attr("width",s(l.domain()[l.domain().length-1],i)+1.1*l.bandwidth()),a.exit().remove()}function j(e){var n=t.mouse(t.event.target)[1],r=t.mouse(t.event.target)[0],i=W(A[e.level],n),a=W(l,r-c(e.level)),o=m.get(i);O.select(".nvTooltip").attr("transform","translate("+r+","+(n+20)+")").call(function(t){t.select(".tool_id").text(i),t.select(".tool_value_name").text(a+" : "),t.select(".tool_value_val").text(o[a])})}function Q(){O.select(".nvTooltip").attr("transform","translate(-200,-200)").call(function(t){t.select(".tool_id").text(""),t.select(".tool_value_name").text(""),t.select(".tool_value_val").text("")})}function Y(e){var n=l.domain(),r=O.select(".attribs").selectAll(".levelOverlay").data(v),i=r.enter().append("g");i.attr("class","levelOverlay").attr("id",function(t,e){return"level"+e}),e?i.merge(r).each(L):i.each(L);var a,o=i.merge(r).selectAll(".attribOverlay").data(function(t,e){return n.map(function(t){return{attrib:t,level:e}})}),d=o.enter().append("g").attr("class","attribOverlay").style("cursor","pointer");d.merge(o).attr("transform",function(t){return"translate("+s(t.attrib,t.level)+","+A[t.level].range()[0]+")"}),d.append("rect").merge(o.select("rect")).attr("fill","none").attr("x",0).attr("y",0).attr("width",function(){return 1.1*l.bandwidth()}).attr("height",function(t){return A[t.level].range()[1]-A[t.level].range()[0]}),d.append("text").merge(o.select("text")).style("cursor","point").style("-webkit-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").text(function(t){return"__seqId"===t.attrib?"sequential Index":t.attrib+(void 0!==x[t.level]&&x[t.level].attrib===t.attrib?x[t.level].reverse?" ↓":" ↑":"")}).attr("x",l.bandwidth()/2).attr("y",0).style("font-weight",function(t){return void 0!==x[t.level]&&x[t.level].attrib===t.attrib?"bolder":"normal"}).style("font-family","sans-serif").style("font-size",function(e){return void 0!==x[e.level]&&x[e.level].attrib===e.attrib&&t.select(this).dispatch("mousemove"),f.attribFontSize+"px"}).on("click",(a=K,function(t,e,n){F(this),setTimeout(()=>{a(t,e,n),$(this)},100)})).call(t.drag().container(d.merge(o).node()).on("start",H).on("drag",J).on("end",X)).on("mousemove",function(){var e=t.select(this);(e=void 0!==e.transition?e.transition().duration(150):e).style("font-size",f.attribFontSizeSelected+"px")}).on("mouseout",function(){var e=t.select(this);(e=void 0!==e.transition?e.transition().duration(150):e).style("font-size",f.attribFontSize+"px")}).attr("transform","rotate(-45)"),i.append("text").merge(r.select("text.numNodesLabel")).attr("class","numNodesLabel").style("font-family","sans-serif").style("pointer-events","none").merge(r.select(".numNodesLabel")).attr("y",function(t,e){return A[e].range()[1]+15}).attr("x",function(t,e){return c(e)}).text(function(t){return q(t.length)}),o.exit().remove(),r.exit().remove()}function H(e){t.event.sourceEvent.shiftKey&&t.select(this.parentNode).attr("transform",function(e){return"translate("+(t.event.x+f.attribFontSize/2)+","+A[e.level].range()[0]+")"})}function J(e){t.event.sourceEvent.shiftKey&&t.select(this.parentNode).attr("transform",function(e){return"translate("+(t.event.x+f.attribFontSize/2)+","+A[e.level].range()[0]+")"})}function X(e){if(t.event.sourceEvent.shiftKey){var n,r=W(l,t.event.x+f.attribFontSize/2-c(e.level));t.select(this.parentNode).attr("transform",function(t){return"translate("+s(t.attrib,t.level)+","+A[t.level].range()[0]+")"}),r!==e.attrib&&(n=y.indexOf(r),et(e.attrib,n),f.updateData(v))}}function Z(t){var e=l.domain()[l.domain().length-1],n=s(e,v.length-1)+l.bandwidth(),r=A[v.length-1](t.source[P])+A[v.length-1].bandwidth()/2,i=A[v.length-1](t.target[P])+A[v.length-1].bandwidth()/2,a=Math.min(r,i),o=Math.max(r,i),c=o-a;u.moveTo(n,a),u.quadraticCurveTo(n+c/6,a+c/2,n,o)}function tt(t,e,n,r){u.beginPath(),t.forEach(function(t,e){0===e?u.moveTo(t.x,t.y):u.lineTo(t.x,t.y)}),u.lineWidth=e,r?(u.fillStyle=n,u.closePath(),u.fill()):(u.strokeStyle=n,u.stroke())}function et(t,e){var n=y.indexOf(t);-1!==n?e>y.length||e<0?console.err("moveAttrToPos pos out of bounds",e,y.length):(y.splice(n,1),y.splice(e,0,t)):console.err("moveAttrToPos attr not found",t)}return d.height=S*B,(u=d.getContext("2d")).scale(B,B),u.imageSmoothingEnabled=u.mozImageSmoothingEnabled=u.webkitImageSmoothingEnabled=!1,u.globalCompositeOperation="source-over",f.initData=function(e,n){performance.now(),(k=n).keys().forEach(function(t){b.set(t,!0)}),m=t.map();for(var r=0;r<h.length;r++){var i=h[r];i.__seqId=r,m.set(i[P],i),i.__i=[],i.__i[0]=r}(_=[])[0]=[],performance.now()},f.updateData=function(e,n,r){const{levelToUpdate:i,updateColorDomains:a}=r||{};var o;performance.now(),typeof e==typeof[]?(k=void 0!==n?n:k,v=e,_.splice(e.length),_[e.length]=[],p.length>0&&(g=p.filter(function(t){return t.source.visible&&t.target.visible})),w.splice(e.length),G(e.length-1),function(e){let{levelToUpdate:n,updateColorDomains:r}=e||{};performance.now();const i=v.length-1;n=void 0!==n?n:i,r=void 0!==r&&r,A.splice(i+1,A.length),A[n]=t.scaleBand().range([I,S-f.margin-30]).paddingInner(0).paddingOuter(0);let a=[];if(v[n].length>S){const t=Math.max(Math.floor(v[n].length/(2*S)),1);v[n].itemsPerpixel=t;for(let e=0;e<v[n].length;e+=t)a.push(v[n][e])}else v[n].itemsPerpixel=1,a=v[n];v[n].representatives=a,A[n].domain(a.map(function(t){return h[t][P]})),l.domain(y).range([0,f.attribWidth*b.keys().length]).paddingInner(.1).paddingOuter(0),c.domain(v.map(function(t,e){return e})).range([E+f.margin,(l.range()[1]+f.levelsSeparation)*v.length+E]).paddingInner(0).paddingOuter(0),r&&b.keys().forEach(function(e){if("visible"!==e){var n=k.get(e);if("seq"===n.__type||"date"===n.__type)n.domain(t.extent(v[0].map(function(t){return h[t][e]})));else if("div"===n.__type){const[r,i]=t.extent(v[0].map(function(t){return h[t][e]})),a=Math.max(-r,i);n.domain([-a,a])}else"text"===n.__type&&n.domain(v[0].map(t=>h[t][e]));k.set(e,n)}}),performance.now()}({levelToUpdate:i,updateColorDomains:a}),o=c.range()[1]+f.margin+E,t.select(d).attr("width",o).attr("height",S).style("width",o).style("height",S+"px"),d.style.width=o+"px",d.style.height=S+"px",O.attr("width",o).attr("height",S),f.update(),performance.now()):console.error("navio updateData didn't receive an array")},f.update=function(t){var e,n=void 0!==t&&t,r=(performance.now(),c.range()[1]+f.margin+E);u.clearRect(0,0,r+1,S+1),v.forEach(function(t,e){var n;!function(t){u.beginPath(),u.rect(c(t),A[t].range()[0]-1,l.range()[1]+1,A[t].range()[1]+2-100),u.strokeStyle="black",u.lineWidth=1,u.stroke()}(e),t.representatives.forEach(function(t){!function(t,e){var n,r,i;for(r=0;r<y.length;r++)if(n=y[r],i=Math.round(A[e](t[P])+A[e].bandwidth()/2),u.beginPath(),u.moveTo(Math.round(s(n,e)),i),u.lineTo(Math.round(s(n,e)+l.bandwidth()),i),u.lineWidth=Math.ceil(A[e].bandwidth())+1,u.strokeStyle=void 0===t[n]||null===t[n]||""===t[n]||"none"===t[n]?"white":k.get(n)(t[n]),u.stroke(),A[e].bandwidth()>2*f.divisionsThreshold){var a=Math.round(A[e](t[P]));u.beginPath(),u.moveTo(s(n,e),a),u.lineTo(s(n,e)+l.bandwidth(),a),u.lineWidth=1,u.strokeStyle=f.divisionsColor,u.stroke()}}(h[t],e)}),(n=e)<=0||v[n].representatives.forEach(function(t){var e=m.get(h[t][P]).__i[n-1],r=Math.floor(e-e%v[n-1].itemsPerpixel),i={x:c(n-1)+l.range()[1],y:A[n-1](h[v[n-1][r]][P])},a={x:c(n),y:A[n](h[t][P])},o=[i,{x:i.x+.3*f.levelsSeparation,y:i.y},{x:a.x-.3*f.levelsSeparation,y:a.y},a,{x:a.x,y:a.y+A[n].bandwidth()},{x:a.x-.3*f.levelsSeparation,y:a.y+A[n].bandwidth()},{x:i.x+.3*f.levelsSeparation,y:i.y+A[n-1].bandwidth()},{x:i.x,y:i.y+A[n-1].bandwidth()},i];tt(o,1,f.levelConvectionsColor),tt(o,1,f.levelConvectionsColor,!0)})}),p.length&&(u.save(),u.beginPath(),u.strokeStyle=f.linkColor,u.globalAlpha=Math.min(1,Math.max(.1,1e3/p[p.length-1].length)),g.forEach(Z),u.stroke(),u.restore()),Y(n),e=v.length-1,O.select("#closeButton").style("display",1===v.length?"none":"block").attr("transform","translate("+(c(e)+c.bandwidth()-f.levelsSeparation+15)+","+A[e].range()[0]+")"),performance.now()},f.addAttrib=function(t,e){if(-1===y.indexOf(t))return y.push(t),k.set(t,e),f},f.addSequentialAttrib=function(e,n){const r=void 0!==h&&h.length>0?t.extent(h,function(t){return t[e]}):[0,1],i=n||t.scaleSequential(T).domain(r);return i.__type="seq",f.addAttrib(e,i),f},f.addDateAttrib=function(e,n){const r=void 0!==h&&h.length>0?t.extent(h,function(t){return t[e]}):[0,1],i=n||t.scaleSequential(C).domain(r);return f.addAttrib(e,i),i.__type="date",f},f.addDivergingAttrib=function(e,n){const r=void 0!==h&&h.length>0?t.extent(h,function(t){return t[e]}):[-1,1],i=n||t.scaleSequential(N).domain([r[0],r[1]]);return i.__type="div",f.addAttrib(e,i),f},f.addCategoricalAttrib=function(e,n){const r=n||t.scaleOrdinal(t.schemeCategory10);return r.__type="cat",f.addAttrib(e,r),f},f.addTextAttrib=function(t,e){const n=e||i();return f.addAttrib(t,n),f},f.addAllAttribs=function(e){if(!h||!h.length)throw Error("addAllAttribs called without data to guess the attribs. Make sure to call it after setting the data");return(void 0!==e?e:function(t){var e,n=[];for(e in t)t.hasOwnProperty(e)&&n.push(e);return n}(h[0])).forEach(function(e){if("__seqId"===e||"__i"===e||"visible"===e)return;const n=function(t,e){let n,r;for(n=0;n<f.howManyItemsShouldSearchForNotNull&&n<t.length;n++)if(null!=(r=t[n][e])&&""!==r)return r;return r}(h,e);if(null==n||"string"==typeof n){const t=i().computeRepresentatives(h.slice(0,f.howManyItemsShouldSearchForNotNull).map(t=>t[e])).counts;t.keys().length<f.maxNumDistictForCategorical?(console.log(`Navio: Adding attr ${e} as categorical`),f.addCategoricalAttrib(e)):(console.log(`Navio: Attr ${e} has too many distinct elements (${t.keys().length}) using textAttrib`),f.addTextAttrib(e))}else"number"==typeof n?t.min(h,t=>t[e])<0?(console.log(`Navio: Adding attr ${e} as diverging`),f.addDivergingAttrib(e)):(console.log(`Navio: Adding attr ${e} as sequential`),f.addSequentialAttrib(e)):typeof n==typeof new Date?(console.log(`Navio: Adding attr ${e} as date`),f.addDateAttrib(e)):(console.log(`Navio: Don't know what to do with attr ${e} adding as text (type=${typeof n})`),f.addTextAttrib(e))}),f.data(h),Y(!0),f},f.data=function(e){return k.has("visible")||(f.addAttrib("visible",t.scaleOrdinal().domain([!1,!0]).range(D)),et("visible",0)),k.has("__seqId")||(f.addSequentialAttrib("__seqId"),et("__seqId",1)),arguments.length?((h=e.slice(0)).forEach(function(t){t.visible=!0}),v=[h.map(function(t,e){return e})],f.initData(v,k),f.updateData(v,k,{updateColorDomains:!0}),f):h[0]},f.getVisible=function(){return v[v.length-1].filter(function(t){return h[t].visible}).map(function(t){return h[t]})},f.updateCallback=function(t){return arguments.length?(M=t,f):M},f.visibleColorRange=function(t){return arguments.length?(D=t,f):D},f.defaultColorInterpolator=function(t){return arguments.length?(T=t,f):T},f.id=function(t){return arguments.length?(P=t,f):P},f.links=function(t){return arguments.length?(p=t,f):p},f}});
